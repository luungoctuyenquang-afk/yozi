<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldBook Engine Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .file-input-wrapper:hover {
            background: #5a6fd8;
        }

        .file-input-wrapper input {
            position: absolute;
            left: -9999px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item input[type="checkbox"] {
            width: auto;
        }

        .option-item input[type="number"] {
            width: 80px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .results {
            margin-top: 30px;
        }

        .results-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .position-group {
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            overflow: hidden;
        }

        .position-header {
            background: #667eea;
            color: white;
            padding: 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .entry-item {
            padding: 20px;
            border-bottom: 1px solid #e1e5e9;
            background: white;
        }

        .entry-item:last-child {
            border-bottom: none;
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .entry-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .entry-meta {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .entry-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-style: italic;
            border-left: 3px solid #667eea;
        }

        .matched-keys {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .matched-key {
            background: #e7f3ff;
            color: #0066cc;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 6px;
            }

            .main-content {
                padding: 20px;
            }

            .options-grid {
                grid-template-columns: 1fr;
            }

            .entry-header {
                flex-direction: column;
                align-items: start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ WorldBook Engine Demo</h1>
            <p>é›¶ä¾èµ–çº¯å‰ç«¯ä¸–ç•Œä¹¦å¼•æ“æµ‹è¯•å·¥å…·</p>
            <div id="wb-status" style="opacity:.7; margin: 10px 0; font-size: 14px; color: #666;"></div>
            <div id="loadedStatus" style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; font-size: 0.9em; display: none;">
                å·²åŠ è½½ï¼š<span id="loadedBookName"></span>ï¼ˆ<span id="loadedEntriesCount"></span> æ¡ç›®ï¼‰
            </div>
        </div>

        <div class="main-content">
            <!-- æ–‡ä»¶å¯¼å…¥åŒº -->
            <div class="section">
                <h2>ğŸ“ å¯¼å…¥ä¸–ç•Œä¹¦æ–‡ä»¶</h2>
                <div class="form-group">
                    <label class="file-input-wrapper">
                        é€‰æ‹© JSON æ–‡ä»¶
                        <input type="file" id="fileInput" accept=".json,.worldbook" />
                    </label>
                    <button class="btn btn-secondary" id="loadSampleBtn" style="margin-left: 10px;">
                        åŠ è½½ç¤ºä¾‹æ–‡ä»¶
                    </button>
                    <button class="btn btn-info" id="importSelfCheckBtn" style="margin-left: 10px;">
                        å¯¼å…¥è‡ªæ£€
                    </button>
                </div>
                <div id="fileStatus"></div>
            </div>

            <!-- è¾“å…¥åŒº -->
            <div class="section">
                <h2>ğŸ’¬ è¾“å…¥å½“å‰æ¶ˆæ¯</h2>
                <div class="form-group">
                    <label for="contextInput">å½“å‰å¯¹è¯å†…å®¹ï¼š</label>
                    <textarea 
                        id="contextInput" 
                        placeholder="è¾“å…¥ä¸€æ®µè¯æ¥æµ‹è¯•ä¸–ç•Œä¹¦å¼•æ“ï¼Œä¾‹å¦‚ï¼š'æˆ‘æƒ³å»å·´é»æ—…æ¸¸ï¼Œéœ€è¦æ³¨æ„ä»€ä¹ˆå®‰å…¨äº‹é¡¹ï¼Ÿ'"
                    ></textarea>
                </div>
            </div>

            <!-- å¼•æ“è®¾ç½® -->
            <div class="section">
                <h2>âš™ï¸ å¼•æ“å‚æ•°è®¾ç½®</h2>
                <div class="options-grid">
                    <div class="option-item">
                        <label>æ‰«ææ·±åº¦:</label>
                        <input type="number" id="scanDepth" value="1000" min="1" max="5000">
                    </div>
                    <div class="option-item">
                        <input type="checkbox" id="recursive" checked>
                        <label for="recursive">å¯ç”¨é€’å½’å¤„ç†</label>
                    </div>
                    <div class="option-item">
                        <label>æœ€å°æ¿€æ´»æ•°:</label>
                        <input type="number" id="minActivations" value="1" min="1" max="10">
                    </div>
                    <div class="option-item">
                        <label>æœ€å¤§æ·±åº¦:</label>
                        <input type="number" id="maxDepth" value="3" min="1" max="10">
                    </div>
                    <div class="option-item">
                        <label>æœ€å¤§é€’å½’æ­¥æ•°:</label>
                        <input type="number" id="maxRecursionSteps" value="10" min="1" max="50">
                    </div>
                    <div class="option-item">
                        <label>ä»¤ç‰Œé¢„ç®—:</label>
                        <input type="number" id="tokenBudget" value="2000" min="100" max="10000">
                    </div>
                </div>
            </div>

            <!-- è¿è¡ŒæŒ‰é’® -->
            <div class="section">
                <button class="btn" id="runEngineBtn">ğŸš€ è¿è¡Œå¼•æ“</button>
                <button class="btn btn-secondary" id="clearResultsBtn" style="margin-left: 10px;">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
                <button class="btn btn-secondary" id="selfCheckBtn" style="margin-left: 10px;">ğŸ” å¯¼å…¥è‡ªæ£€</button>
            </div>

            <!-- ç»“æœæ˜¾ç¤ºåŒº -->
            <div class="results" id="results" style="display: none;">
                <h2>ğŸ“Š å¤„ç†ç»“æœ</h2>
                <div id="resultsSummary"></div>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script src="index.iife.js"></script>
    <script>
        // ä½ç½®åæ˜ å°„ï¼ˆæŠŠ top/afterSystem/... æ˜ å°„åˆ°æ ‡å‡†ä½ï¼‰
        const POS_MAP = {
            top:'before_char', beforeMain:'before_an', afterMain:'after_an',
            afterSystem:'after_char', afterExample:'after_example',
            bottom:'after_char', floating:'after_char', unknown:'after_char'
        };
        const mapPos = p => POS_MAP[p] || p || 'after_char';

        // ç»Ÿä¸€æŠŠå¼•æ“è¿”å›å½’ä¸€åŒ–ä¸º [{position, entries: ActivatedEntry[]}]
        function normSlots(out){
            if (Array.isArray(out)) {
                // å¯èƒ½ç›´æ¥æ˜¯ ActivatedEntry[]ï¼ˆæ²¡æœ‰ entries å­—æ®µï¼‰
                if (out.length && !out[0]?.entries) return [{ position:'after_char', entries: out }];
                return out;
            }
            if (out?.slots){
                if (Array.isArray(out.slots)) return out.slots.map(s => ({ position: mapPos(s.position), entries: s.entries||[] }));
                if (typeof out.slots === 'object') return Object.entries(out.slots).map(([p,arr]) => ({ position: mapPos(p), entries: Array.isArray(arr)?arr:[] }));
            }
            if (Array.isArray(out?.activatedEntries)) return [{ position:'after_char', entries: out.activatedEntries }];
            return [];
        }
        // é˜²å¾¡ï¼šæœ‰äº›åœ°æ–¹æŠŠ"æ§½ä½å€¼æœ¬ä½“"å°±æ˜¯æ•°ç»„
        const listOf = s => Array.isArray(s?.entries) ? s.entries : (Array.isArray(s) ? s : []);

        // å…¨å±€ä¹¦ç±ç®¡ç†å‡½æ•°
        function setCurrentBook(book){
            window.__currentWorldBook = book;
            try{ localStorage.setItem('worldbook', JSON.stringify(book)); }catch(e){}
            const name = book?.name || 'æœªå‘½å';
            const n    = book?.entries?.length || 0;
            document.getElementById('wb-status')?.replaceChildren(document.createTextNode(`å·²åŠ è½½ï¼š${name}ï¼ˆ${n} æ¡ç›®ï¼‰`));
        }

        function getCurrentBook(){
            if (window.__currentWorldBook?.entries?.length) return window.__currentWorldBook;
            try{
                const raw = JSON.parse(localStorage.getItem('worldbook')||'null');
                if (raw) return (window.WorldBookKit?.WorldBookImporter?.import ? window.WorldBookKit.WorldBookImporter.import(raw) : raw);
            }catch(e){}
            return (typeof SAMPLE_BOOK!=='undefined'
                ? (window.WorldBookKit?.WorldBookImporter?.import ? window.WorldBookKit.WorldBookImporter.import(SAMPLE_BOOK) : SAMPLE_BOOK)
                : null);
        }

        class WorldBookDemo {
            constructor() {
                this.engine = new WorldBookKit.WorldBookEngine({
                    matchWholeWords: false  // å…³é”®ä¿®å¤ï¼šç¦ç”¨å…¨è¯åŒ¹é…ä»¥æ”¯æŒä¸­æ–‡
                });
                this.worldbook = null;
                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('fileInput').addEventListener('change', this.handleFileSelect.bind(this));
                document.getElementById('loadSampleBtn').addEventListener('click', this.loadSampleFile.bind(this));
                document.getElementById('runEngineBtn').addEventListener('click', this.runEngine.bind(this));
                document.getElementById('clearResultsBtn').addEventListener('click', this.clearResults.bind(this));
                document.getElementById('selfCheckBtn').addEventListener('click', this.runSelfCheck.bind(this));
                document.getElementById('importSelfCheckBtn').addEventListener('click', this.runImportSelfCheck.bind(this));

                const inputs = ['scanDepth', 'recursive', 'minActivations', 'maxDepth', 'maxRecursionSteps', 'tokenBudget'];
                inputs.forEach(id => {
                    document.getElementById(id).addEventListener('change', this.updateEngineOptions.bind(this));
                });
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                try {
                    const text = await decodeFileToText(file);
                    const raw = JSON.parse(text);
                    const book = (window.WorldBookKit?.WorldBookImporter?.import ? window.WorldBookKit.WorldBookImporter.import(raw) : raw);
                    
                    setCurrentBook(book);
                    this.worldbook = book;
                    
                    this.showStatus(`âœ… å·²åŠ è½½ï¼š${book.name || 'æœªå‘½å'}ï¼ˆ${book.entries?.length||0} æ¡ç›®ï¼‰`, 'success');
                    this.updateLoadedStatus();
                    this.validateWorldbook();
                } catch (error) {
                    this.showStatus(`âŒ æ–‡ä»¶åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                }
            }

            loadSampleFile() {
                try {
                    const book = (window.WorldBookKit?.WorldBookImporter?.import)
                        ? window.WorldBookKit.WorldBookImporter.import(SAMPLE_BOOK)
                        : SAMPLE_BOOK;
                    
                    setCurrentBook(book);
                    this.worldbook = book;
                    
                    this.showStatus(`âœ… å·²åŠ è½½ï¼š${book.name || 'æœªå‘½å'}ï¼ˆ${book.entries?.length||0} æ¡ç›®ï¼‰`, 'success');
                    this.updateLoadedStatus();
                    this.validateWorldbook();
                    
                    document.getElementById('contextInput').value = 'æµ·å— äºšé¾™æ¹¾ å¤©æ°” é¤å…æ¨è æ³¨æ„äº‹é¡¹';
                } catch (error) {
                    this.showStatus('âŒ æ— æ³•åŠ è½½ç¤ºä¾‹æ–‡ä»¶', 'error');
                }
            }

            validateWorldbook() {
                if (!this.worldbook) return;

                const validation = WorldBookKit.WorldBookImporter.validate(this.worldbook);
                if (!validation.valid) {
                    this.showStatus(`âš ï¸ ä¸–ç•Œä¹¦æ ¼å¼æœ‰é—®é¢˜: ${validation.errors.join(', ')}`, 'error');
                } else {
                    this.showStatus(`âœ… ä¸–ç•Œä¹¦éªŒè¯é€šè¿‡ï¼ŒåŒ…å« ${this.worldbook.entries.length} ä¸ªæ¡ç›®`, 'success');
                    this.updateLoadedStatus();
                }
            }

            updateLoadedStatus() {
                if (!this.worldbook) return;
                
                const statusDiv = document.getElementById('loadedStatus');
                const bookNameSpan = document.getElementById('loadedBookName');
                const entriesCountSpan = document.getElementById('loadedEntriesCount');
                
                bookNameSpan.textContent = this.worldbook.name || 'æœªçŸ¥ä¸–ç•Œä¹¦';
                entriesCountSpan.textContent = this.worldbook.entries.length;
                statusDiv.style.display = 'block';
            }

            updateEngineOptions() {
                const options = {
                    scanDepth: parseInt(document.getElementById('scanDepth').value),
                    recursive: document.getElementById('recursive').checked,
                    minActivations: parseInt(document.getElementById('minActivations').value),
                    maxDepth: parseInt(document.getElementById('maxDepth').value),
                    maxRecursionSteps: parseInt(document.getElementById('maxRecursionSteps').value),
                    tokenBudget: parseInt(document.getElementById('tokenBudget').value),
                    matchWholeWords: false  // ç¡®ä¿ä¸­æ–‡åŒ¹é…æ­£å¸¸å·¥ä½œ
                };

                this.engine.setOptions(options);
            }

            runEngine() {
                const book = getCurrentBook();
                console.info('[WorldBook] run with', book?.name, book?.entries?.length);
                
                if (!book || !book.entries || book.entries.length === 0) {
                    this.showStatus('âŒ è¯·å…ˆåŠ è½½ä¸–ç•Œä¹¦æ–‡ä»¶', 'error');
                    return;
                }

                const context = document.getElementById('contextInput').value.trim();
                if (!context) {
                    this.showStatus('âŒ è¯·è¾“å…¥æµ‹è¯•å†…å®¹', 'error');
                    return;
                }

                this.updateEngineOptions();

                try {
                    const startTime = performance.now();
                    const raw = this.engine.process(book, context);
                    const slots = normSlots(raw);
                    const hits = slots.reduce((n, s) => n + listOf(s).length, 0);
                    const endTime = performance.now();
                    const processingTime = (endTime - startTime).toFixed(2);

                    console.debug('[WorldBook] run with', book?.name, book?.entries?.length, 'slots=', slots.length, 'hits=', hits);
                    this.displayResults({slots, activatedEntries: slots.flatMap(s=>listOf(s))}, context, processingTime);
                    this.showStatus(`âœ… å¼•æ“è¿è¡Œå®Œæˆï¼Œè€—æ—¶ ${processingTime}ms`, 'success');
                } catch (error) {
                    this.showStatus(`âŒ å¼•æ“è¿è¡Œå¤±è´¥: ${error.message}`, 'error');
                }
            }

            displayResults(result, context, processingTime) {
                const resultsDiv = document.getElementById('results');
                const summaryDiv = document.getElementById('resultsSummary');
                const contentDiv = document.getElementById('resultsContent');

                resultsDiv.style.display = 'block';

                const totalEntries = result.activatedEntries.length;
                const totalSlots = Object.keys(result.slots).filter(key => result.slots[key].length > 0).length;
                const estimatedTokens = result.activatedEntries.reduce((sum, entry) => sum + Math.ceil((entry.content || '').length / 4), 0);

                summaryDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${totalEntries}</div>
                            <div class="stat-label">æ¿€æ´»æ¡ç›®</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${totalSlots}</div>
                            <div class="stat-label">ä½¿ç”¨ä½ç½®</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${estimatedTokens}</div>
                            <div class="stat-label">é¢„è®¡ä»¤ç‰Œ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${processingTime}ms</div>
                            <div class="stat-label">å¤„ç†æ—¶é—´</div>
                        </div>
                    </div>
                    <p><strong>è¾“å…¥å†…å®¹:</strong> "${context}"</p>
                `;

                let contentHTML = '';
                const positionNames = {
                    'top': 'ğŸ” é¡¶éƒ¨',
                    'afterSystem': 'ğŸ”„ ç³»ç»Ÿå',
                    'afterExample': 'ğŸ“ ç¤ºä¾‹å',
                    'beforeMain': 'â¬†ï¸ ä¸»è¦å‰',
                    'afterMain': 'â¬‡ï¸ ä¸»è¦å',
                    'bottom': 'ğŸ”½ åº•éƒ¨',
                    'floating': 'ğŸˆ æµ®åŠ¨',
                    'unknown': 'â“ æœªçŸ¥ä½ç½®'
                };

                const slots = result.slots || [];
                (Array.isArray(slots) ? slots : Object.entries(slots).map(([p,arr]) => ({position:p, entries:arr}))).forEach(slot => {
                    const entries = listOf(slot);
                    if (entries.length === 0) return;

                    const positionName = positionNames[slot.position] || slot.position;
                    contentHTML += `
                        <div class="position-group">
                            <div class="position-header">
                                <span>${positionName}</span>
                                <span class="position-count">${entries.length} æ¡</span>
                            </div>
                    `;

                    entries.forEach(entry => {
                        const matchedKeysHTML = entry.matchedKeys && entry.matchedKeys.length > 0 
                            ? `<div class="matched-keys">
                                ${entry.matchedKeys.map(key => `<span class="matched-key">${key}</span>`).join('')}
                               </div>` 
                            : '';

                        contentHTML += `
                            <div class="entry-item">
                                <div class="entry-header">
                                    <div class="entry-title">${entry.name || `æ¡ç›® ${entry.id}`}</div>
                                </div>
                                <div class="entry-meta">
                                    <span>ID: ${entry.id}</span>
                                    <span>ä¼˜å…ˆçº§: ${entry.priority || 0}</span>
                                    <span>é¡ºåº: ${entry.order || 0}</span>
                                    ${entry.constant ? '<span style="color: #28a745;">å¸¸é©»</span>' : ''}
                                    ${entry.sticky ? '<span style="color: #fd7e14;">ç²˜æ€§</span>' : ''}
                                    ${entry.group ? `<span>åˆ†ç»„: ${entry.group}</span>` : ''}
                                    ${entry.depth !== undefined ? `<span>æ·±åº¦: ${entry.depth}</span>` : ''}
                                    ${entry.activationScore ? `<span>è¯„åˆ†: ${Math.round(entry.activationScore)}</span>` : ''}
                                </div>
                                <div class="entry-content">
                                    ${entry.content || 'æ— å†…å®¹'}
                                </div>
                                ${matchedKeysHTML}
                            </div>
                        `;
                    });

                    contentHTML += '</div>';
                });

                if (contentHTML === '') {
                    contentHTML = '<p style="text-align: center; color: #666; padding: 40px;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¡ç›®</p>';
                }

                contentDiv.innerHTML = contentHTML;
            }

            clearResults() {
                const resultsDiv = document.getElementById('results');
                resultsDiv.style.display = 'none';
                this.showStatus('ğŸ—‘ï¸ ç»“æœå·²æ¸…ç©º', 'success');
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('fileStatus');
                statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 5000);
            }

            runSelfCheck() {
                if (!this.worldbook) {
                    this.showStatus('âŒ è¯·å…ˆåŠ è½½ä¸–ç•Œä¹¦æ–‡ä»¶', 'error');
                    return;
                }

                const book = this.worldbook;
                const entries = book.entries || [];

                // ç»Ÿè®¡ä¿¡æ¯
                const stats = {
                    ä¹¦å: book.name || 'æœªå‘½å',
                    æ€»æ¡ç›®æ•°: entries.length,
                    keysä¸ºç©ºçš„æ¡ç›®æ•°: 0,
                    enabledä¸ºfalseçš„æ¡ç›®æ•°: 0,
                    ä½ç½®ç»Ÿè®¡: {}
                };

                const emptyKeysEntries = [];
                const disabledEntries = [];

                const safeEntries = Array.isArray(entries) ? entries : [];
                safeEntries.forEach(entry => {
                    // æ£€æŸ¥ keys ä¸ºç©º
                    if (!entry.keys || entry.keys.length === 0) {
                        stats.keysä¸ºç©ºçš„æ¡ç›®æ•°++;
                        if (emptyKeysEntries.length < 5) {
                            emptyKeysEntries.push({
                                id: entry.id,
                                name: entry.name || 'æ— åç§°'
                            });
                        }
                    }

                    // æ£€æŸ¥ enabled ä¸º false
                    if (entry.enabled === false) {
                        stats.enabledä¸ºfalseçš„æ¡ç›®æ•°++;
                        if (disabledEntries.length < 5) {
                            disabledEntries.push({
                                id: entry.id,
                                name: entry.name || 'æ— åç§°'
                            });
                        }
                    }

                    // ç»Ÿè®¡ä½ç½®
                    const position = entry.position || 'after_char';
                    stats.ä½ç½®ç»Ÿè®¡[position] = (stats.ä½ç½®ç»Ÿè®¡[position] || 0) + 1;
                });

                // éšæœºå– 3 ä¸ªæ¡ç›®çš„è¯¦ç»†ä¿¡æ¯
                const sampleEntries = [];
                const shuffled = [...safeEntries].sort(() => 0.5 - Math.random());
                for (let i = 0; i < Math.min(3, shuffled.length); i++) {
                    const entry = shuffled[i];
                    sampleEntries.push({
                        id: entry.id,
                        name: entry.name || 'æ— åç§°',
                        keys: (entry.keys || []).join(', '),
                        content_preview: (entry.content || '').slice(0, 20) + (entry.content && entry.content.length > 20 ? '...' : '')
                    });
                }

                // è¾“å‡ºåˆ°æ§åˆ¶å°
                console.group('ğŸ” ä¸–ç•Œä¹¦å¯¼å…¥è‡ªæ£€æŠ¥å‘Š');
                console.table([stats]);
                
                if (emptyKeysEntries.length > 0) {
                    console.warn(`keys ä¸ºç©ºçš„æ¡ç›®ï¼ˆå‰ ${emptyKeysEntries.length} ä¸ªï¼‰:`, emptyKeysEntries);
                }
                
                if (disabledEntries.length > 0) {
                    console.warn(`enabled=false çš„æ¡ç›®ï¼ˆå‰ ${disabledEntries.length} ä¸ªï¼‰:`, disabledEntries);
                }
                
                console.log('ä½ç½®åˆ†å¸ƒ:', stats.ä½ç½®ç»Ÿè®¡);
                console.log('éšæœºæ ·æœ¬æ¡ç›®:', sampleEntries);
                console.groupEnd();

                // æ˜¾ç¤ºç®€è¦ç»“æœ
                const summary = `ğŸ“Š è‡ªæ£€å®Œæˆï¼æ€»æ¡ç›®ï¼š${stats.æ€»æ¡ç›®æ•°}ï¼Œkeysä¸ºç©ºï¼š${stats.keysä¸ºç©ºçš„æ¡ç›®æ•°}ï¼Œå·²ç¦ç”¨ï¼š${stats.enabledä¸ºfalseçš„æ¡ç›®æ•°}`;
                this.showStatus(summary, 'success');
            }

            runImportSelfCheck() {
                const book = getCurrentBook();
                if (!book?.entries) {
                    this.showStatus('âŒ å°šæœªåŠ è½½ä¸–ç•Œä¹¦', 'error');
                    return;
                }
                
                const entries = Array.isArray(book.entries) ? book.entries : [];
                const emptyKeys = entries.filter(e => !Array.isArray(e.keys) || e.keys.length === 0).slice(0, 5);
                
                console.group('ä¸–ç•Œä¹¦å¯¼å…¥è‡ªæ£€');
                console.log('keys ä¸ºç©ºçš„æ¡ç›®ï¼ˆå‰ 5 ä¸ªï¼‰:', emptyKeys);
                console.groupEnd();
                
                this.showStatus(`âœ… è‡ªæ£€å®Œæˆï¼škeys ä¸ºç©º ${emptyKeys.length} æ¡ï¼ˆè¯¦æƒ…çœ‹æ§åˆ¶å°ï¼‰`, 'success');
            }
        }

        // é€šç”¨ç¼–ç æ£€æµ‹å’ŒBOMç§»é™¤å‡½æ•°
        async function decodeFileToText(file) {
            const buf = await file.arrayBuffer();
            const tryList = [
                {enc:'utf-8', bom:true},
                {enc:'utf-16le', bom:true},
                {enc:'utf-16be', bom:true},
                {enc:'gb18030'},
                {enc:'gbk'},
                {enc:'big5'},
            ];
            for (const opt of tryList) {
                try {
                    let t = new TextDecoder(opt.enc, {fatal:false}).decode(buf);
                    t = stripBOM(t);
                    JSON.parse(t); // è¯•è§£æ
                    return t;      // æˆåŠŸå°±è¿”å›
                } catch (e) { /* try next */ }
            }
            // éƒ½ä¸è¡Œæ—¶ï¼Œæœ€åå†ç”¨ utf-8 å®½æ¾è§£ç è¿”å›ï¼ˆç»™ç”¨æˆ·æç¤ºï¼‰
            return stripBOM(new TextDecoder('utf-8').decode(buf));
        }

        function stripBOM(str){ return str.replace(/^\uFEFF/, ''); }

        // å†…åµŒç¤ºä¾‹æ•°æ®ï¼Œé¿å… fetch é—®é¢˜
        const SAMPLE_BOOK = {
            "name": "Travel World Book",
            "description": "A comprehensive world book for travel scenarios",
            "version": "1.0.0",
            "entries": [
                {
                    "id": "wbe_001",
                    "name": "Constant Travel Context",
                    "keys": [],
                    "content": "The world is vast and filled with wonders to explore. Every journey begins with a single step, and every destination holds unique stories and experiences.",
                    "constant": true,
                    "position": "top",
                    "priority": 100,
                    "order": 1,
                    "comment": "Always active travel context"
                },
                {
                    "id": "wbe_002",
                    "name": "Paris Location",
                    "keys": ["Paris", "Eiffel Tower", "France", "French"],
                    "content": "Paris, the City of Light, is renowned for its art, fashion, gastronomy, and culture. The Eiffel Tower stands as its iconic landmark, while the Seine River flows through the heart of the city. CafÃ©s line the streets, and museums like the Louvre house world-famous artworks.",
                    "position": "afterSystem",
                    "priority": 80,
                    "order": 10,
                    "group": "locations",
                    "probability": 0.9,
                    "sticky": true,
                    "cooldown": 3,
                    "comment": "High priority Paris information"
                },
                {
                    "id": "wbe_003",
                    "name": "Tokyo Location",
                    "keys": ["Tokyo", "Japan", "Japanese", "Shibuya", "Mount Fuji"],
                    "content": "Tokyo is a bustling metropolis where traditional culture meets cutting-edge technology. From the busy crossing at Shibuya to the serene temples, Tokyo offers contrasts at every turn. Mount Fuji can be seen on clear days, and the city's cuisine ranges from street food to Michelin-starred restaurants.",
                    "position": "afterSystem",
                    "priority": 75,
                    "order": 11,
                    "group": "locations",
                    "probability": 0.85,
                    "delay": 2,
                    "comment": "Tokyo travel information"
                },
                {
                    "id": "wbe_004",
                    "name": "New York Location",
                    "keys": ["New York", "NYC", "Manhattan", "Statue of Liberty", "Central Park"],
                    "content": "New York City, the Big Apple, never sleeps. Manhattan's skyline is iconic, Central Park provides green respite, and the Statue of Liberty symbolizes freedom. Broadway shows, world-class museums, and diverse neighborhoods make it a cultural melting pot.",
                    "position": "afterSystem",
                    "priority": 70,
                    "order": 12,
                    "group": "locations",
                    "probability": 0.8,
                    "comment": "New York City details"
                },
                {
                    "id": "wbe_013",
                    "name": "æµ·å—äºšé¾™æ¹¾",
                    "keys": ["æµ·å—", "äºšé¾™æ¹¾", "ä¸‰äºš", "Hainan", "Yalong Bay", "Sanya"],
                    "content": "æµ·å—äºšé¾™æ¹¾æ˜¯ä¸­å›½è‘—åçš„çƒ­å¸¦æµ·æ»¨æ—…æ¸¸èƒœåœ°ï¼Œæ‹¥æœ‰7å…¬é‡Œé•¿çš„é“¶ç™½è‰²æµ·æ»©å’Œæ¸…æ¾ˆçš„æµ·æ°´ã€‚è¿™é‡Œæ°”å€™å®œäººï¼Œå¹´å¹³å‡æ°”æ¸©25.5Â°Cï¼Œæ˜¯åº¦å‡çš„ç†æƒ³é€‰æ‹©ã€‚äºšé¾™æ¹¾å‘¨è¾¹æœ‰ä¼—å¤šåº¦å‡é…’åº—å’Œæ°´ä¸Šè¿åŠ¨è®¾æ–½ã€‚",
                    "position": "afterSystem",
                    "priority": 85,
                    "order": 13,
                    "group": "locations",
                    "probability": 0.95,
                    "sticky": 2,
                    "comment": "æµ·å—äºšé¾™æ¹¾æ—…æ¸¸ä¿¡æ¯"
                },
                {
                    "id": "wbe_005",
                    "name": "Travel Safety Tips",
                    "keys": ["safety", "secure", "dangerous", "risk", "emergency", "å®‰å…¨", "æ³¨æ„äº‹é¡¹", "å±é™©"],
                    "content": "Travel safety is paramount. Always keep copies of important documents, stay aware of your surroundings, use reputable transportation, and inform someone of your itinerary. Research local customs and potential risks before traveling.",
                    "position": "beforeMain",
                    "priority": 90,
                    "order": 5,
                    "selectiveLogic": "AND",
                    "minActivations": 1,
                    "comment": "Important safety information"
                },
                {
                    "id": "wbe_006",
                    "name": "Hotel Booking",
                    "keys": ["hotel", "accommodation", "booking", "reservation", "stay"],
                    "content": "When booking hotels, consider location, amenities, reviews, and cancellation policies. Book in advance for popular destinations and during peak seasons. Compare prices across platforms and read recent guest reviews.",
                    "position": "afterExample",
                    "priority": 60,
                    "order": 20,
                    "probability": 0.7,
                    "comment": "Hotel booking advice"
                },
                {
                    "id": "wbe_007",
                    "name": "Flight Information",
                    "keys": ["flight", "airplane", "airport", "airline", "departure", "arrival"],
                    "content": "Flight planning involves comparing prices, checking baggage policies, and considering departure times. Arrive at airports early, especially for international flights. Check-in online when possible and download airline apps for updates.",
                    "position": "afterExample",
                    "priority": 65,
                    "order": 21,
                    "recursive": true,
                    "maxRecursionSteps": 2,
                    "comment": "Flight travel information"
                },
                {
                    "id": "wbe_008",
                    "name": "Local Transportation",
                    "keys": ["taxi", "bus", "subway", "metro", "transportation", "public transport"],
                    "content": "Local transportation options vary by destination. Research metro/subway systems, bus routes, and taxi services. Consider ride-sharing apps, bike rentals, or walking for short distances. Purchase travel cards for frequent public transport use.",
                    "position": "afterMain",
                    "priority": 50,
                    "order": 30,
                    "nonRecursable": true,
                    "comment": "Transportation within cities"
                },
                {
                    "id": "wbe_009",
                    "name": "Currency Exchange",
                    "keys": ["money", "currency", "exchange", "ATM", "cash", "credit card"],
                    "content": "Handle currency wisely when traveling. Use ATMs for better exchange rates than currency counters. Notify banks of travel plans to avoid card blocks. Carry some cash for places that don't accept cards, but don't carry excessive amounts.",
                    "position": "afterMain",
                    "priority": 55,
                    "order": 31,
                    "blockFurther": true,
                    "delayLevel": 1,
                    "comment": "Financial advice for travelers"
                },
                {
                    "id": "wbe_010",
                    "name": "Cultural Etiquette",
                    "keys": ["culture", "etiquette", "customs", "manners", "respect", "local traditions"],
                    "content": "Respect local cultures and customs. Learn basic phrases in the local language, dress appropriately for religious sites, understand tipping customs, and be mindful of photography restrictions. Research cultural norms before visiting.",
                    "position": "floating",
                    "priority": 40,
                    "order": 40,
                    "probability": 0.6,
                    "maxDepth": 2,
                    "comment": "Cultural awareness for respectful travel"
                },
                {
                    "id": "wbe_011",
                    "name": "Food and Dining",
                    "keys": ["food", "restaurant", "cuisine", "dining", "local food", "eating", "é¤å…", "ç¾é£Ÿ", "é¤å…æ¨è"],
                    "content": "Exploring local cuisine is a highlight of travel. Try street food from reputable vendors, make reservations at popular restaurants, consider dietary restrictions and allergies, and be adventurous with new flavors while being cautious with food safety.",
                    "position": "bottom",
                    "priority": 45,
                    "order": 50,
                    "comment": "Culinary travel experiences"
                },
                {
                    "id": "wbe_012",
                    "name": "Weather Considerations",
                    "keys": ["weather", "climate", "temperature", "rain", "season", "forecast", "å¤©æ°”", "æ°”å€™", "æ¸©åº¦"],
                    "content": "Weather significantly impacts travel experiences. Check forecasts before departure, pack appropriate clothing for the climate, consider seasonal variations and monsoons, and have backup indoor activities for rainy days.",
                    "position": "bottom",
                    "priority": 35,
                    "order": 51,
                    "probability": 0.75,
                    "comment": "Weather planning for travel"
                }
            ],
            "settings": {
                "defaultScanDepth": 1000,
                "defaultRecursive": true,
                "defaultMinActivations": 1,
                "defaultMaxDepth": 3,
                "defaultMaxRecursionSteps": 10,
                "defaultTokenBudget": 2000,
                "matchWholeWords": false
            },
            "metadata": {
                "created": "2025-09-09",
                "author": "WorldBook System",
                "tags": ["travel", "tourism", "culture", "safety"],
                "totalEntries": 13
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            new WorldBookDemo();
        });
    </script>
</body>
</html>