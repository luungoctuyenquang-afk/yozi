<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT密码房间测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔒 MQTT密码房间功能测试</h1>

        <div class="test-section">
            <h2>测试场景1：创建密码保护房间</h2>
            <div>
                <input type="text" id="room1" placeholder="房间号" value="test-pwd-001">
                <input type="text" id="nick1" placeholder="昵称" value="房主Alice">
                <input type="password" id="pwd1" placeholder="房间密码" value="123456">
                <button onclick="createPasswordRoom()">创建密码房间</button>
            </div>
            <div id="result1" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>测试场景2：正确密码加入房间</h2>
            <div>
                <input type="text" id="room2" placeholder="房间号" value="test-pwd-001">
                <input type="text" id="nick2" placeholder="昵称" value="访客Bob">
                <input type="password" id="pwd2" placeholder="房间密码" value="123456">
                <button onclick="joinWithCorrectPassword()">用正确密码加入</button>
            </div>
            <div id="result2" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>测试场景3：错误密码加入房间</h2>
            <div>
                <input type="text" id="room3" placeholder="房间号" value="test-pwd-001">
                <input type="text" id="nick3" placeholder="昵称" value="访客Charlie">
                <input type="password" id="pwd3" placeholder="房间密码" value="wrongpwd">
                <button onclick="joinWithWrongPassword()">用错误密码加入</button>
            </div>
            <div id="result3" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>测试场景4：检查房间设置保存</h2>
            <button onclick="checkSavedConfig()">检查保存的房间配置</button>
            <div id="result4" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>测试场景5：房间人数限制</h2>
            <div>
                <input type="text" id="room5" placeholder="房间号" value="test-limit-001">
                <input type="number" id="maxUsers" placeholder="最大人数" value="2" min="1" max="50">
                <button onclick="testUserLimit()">测试人数限制</button>
            </div>
            <div id="result5" class="log-area"></div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        function log(resultId, message, type = 'info') {
            const resultDiv = document.getElementById(resultId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            resultDiv.innerHTML += `<div class="status ${statusClass}">[${timestamp}] ${message}</div>\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function createPasswordRoom() {
            const roomId = document.getElementById('room1').value;
            const nickname = document.getElementById('nick1').value;
            const password = document.getElementById('pwd1').value;

            log('result1', `正在创建密码保护房间: ${roomId}`, 'info');

            // 模拟创建房间配置
            const roomConfig = {
                roomId: roomId,
                createdBy: nickname,
                password: password,
                isPrivate: true,
                hasPassword: true,
                maxUsers: 20,
                category: 'chat',
                createdAt: Date.now()
            };

            // 保存到localStorage
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            roomConfigs[roomId] = roomConfig;
            localStorage.setItem('mqtt_room_configs', JSON.stringify(roomConfigs));

            log('result1', `✅ 房间创建成功！密码: ${password}`, 'success');
            log('result1', `配置已保存到localStorage`, 'info');
        }

        function joinWithCorrectPassword() {
            const roomId = document.getElementById('room2').value;
            const nickname = document.getElementById('nick2').value;
            const password = document.getElementById('pwd2').value;

            log('result2', `尝试用密码 "${password}" 加入房间: ${roomId}`, 'info');

            // 从localStorage读取房间配置
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            const roomConfig = roomConfigs[roomId];

            if (!roomConfig) {
                log('result2', `❌ 房间 "${roomId}" 不存在！`, 'error');
                return;
            }

            if (roomConfig.isPrivate && roomConfig.password) {
                if (password === roomConfig.password) {
                    log('result2', `✅ 密码正确！成功加入房间`, 'success');
                    log('result2', `欢迎 ${nickname} 加入房间`, 'info');
                } else {
                    log('result2', `❌ 密码错误！无法加入房间`, 'error');
                }
            } else {
                log('result2', `房间无密码保护，直接加入`, 'info');
            }
        }

        function joinWithWrongPassword() {
            const roomId = document.getElementById('room3').value;
            const nickname = document.getElementById('nick3').value;
            const password = document.getElementById('pwd3').value;

            log('result3', `尝试用密码 "${password}" 加入房间: ${roomId}`, 'info');

            // 从localStorage读取房间配置
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            const roomConfig = roomConfigs[roomId];

            if (!roomConfig) {
                log('result3', `❌ 房间 "${roomId}" 不存在！`, 'error');
                return;
            }

            if (roomConfig.isPrivate && roomConfig.password) {
                if (password === roomConfig.password) {
                    log('result3', `✅ 密码正确！成功加入房间`, 'success');
                } else {
                    log('result3', `❌ 密码错误！正确密码应该是: ${roomConfig.password}`, 'error');
                    log('result3', `拒绝访问`, 'error');
                }
            }
        }

        function checkSavedConfig() {
            log('result4', '检查localStorage中的房间配置...', 'info');

            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');

            if (Object.keys(roomConfigs).length === 0) {
                log('result4', '没有保存的房间配置', 'info');
                return;
            }

            for (const [roomId, config] of Object.entries(roomConfigs)) {
                log('result4', `房间: ${roomId}`, 'info');
                log('result4', `  - 创建者: ${config.createdBy}`, 'info');
                log('result4', `  - 有密码: ${config.hasPassword ? '是' : '否'}`, 'info');
                if (config.password) {
                    log('result4', `  - 密码: ${config.password}`, 'info');
                }
                log('result4', `  - 最大人数: ${config.maxUsers || '未设置'}`, 'info');
                log('result4', `  - 类别: ${config.category || '未设置'}`, 'info');
                log('result4', `  - 创建时间: ${new Date(config.createdAt).toLocaleString()}`, 'info');
            }
        }

        function testUserLimit() {
            const roomId = document.getElementById('room5').value;
            const maxUsers = parseInt(document.getElementById('maxUsers').value);

            log('result5', `创建房间 "${roomId}"，最大人数: ${maxUsers}`, 'info');

            // 创建房间配置
            const roomConfig = {
                roomId: roomId,
                createdBy: '房主',
                maxUsers: maxUsers,
                createdAt: Date.now()
            };

            // 保存配置
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            roomConfigs[roomId] = roomConfig;
            localStorage.setItem('mqtt_room_configs', JSON.stringify(roomConfigs));

            // 模拟用户加入
            const onlineUsers = new Set();
            for (let i = 1; i <= maxUsers + 1; i++) {
                if (onlineUsers.size >= maxUsers) {
                    log('result5', `❌ 用户${i} 无法加入：房间已满（${maxUsers}/${maxUsers}）`, 'error');
                } else {
                    onlineUsers.add(`用户${i}`);
                    log('result5', `✅ 用户${i} 成功加入（${onlineUsers.size}/${maxUsers}）`, 'success');
                }
            }
        }

        // 页面加载时清理测试数据
        window.onload = function() {
            log('result1', '测试环境准备就绪', 'info');
        };
    </script>
</body>
</html>