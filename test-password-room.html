<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTå¯†ç æˆ¿é—´æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”’ MQTTå¯†ç æˆ¿é—´åŠŸèƒ½æµ‹è¯•</h1>

        <div class="test-section">
            <h2>æµ‹è¯•åœºæ™¯1ï¼šåˆ›å»ºå¯†ç ä¿æŠ¤æˆ¿é—´</h2>
            <div>
                <input type="text" id="room1" placeholder="æˆ¿é—´å·" value="test-pwd-001">
                <input type="text" id="nick1" placeholder="æ˜µç§°" value="æˆ¿ä¸»Alice">
                <input type="password" id="pwd1" placeholder="æˆ¿é—´å¯†ç " value="123456">
                <button onclick="createPasswordRoom()">åˆ›å»ºå¯†ç æˆ¿é—´</button>
            </div>
            <div id="result1" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•åœºæ™¯2ï¼šæ­£ç¡®å¯†ç åŠ å…¥æˆ¿é—´</h2>
            <div>
                <input type="text" id="room2" placeholder="æˆ¿é—´å·" value="test-pwd-001">
                <input type="text" id="nick2" placeholder="æ˜µç§°" value="è®¿å®¢Bob">
                <input type="password" id="pwd2" placeholder="æˆ¿é—´å¯†ç " value="123456">
                <button onclick="joinWithCorrectPassword()">ç”¨æ­£ç¡®å¯†ç åŠ å…¥</button>
            </div>
            <div id="result2" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•åœºæ™¯3ï¼šé”™è¯¯å¯†ç åŠ å…¥æˆ¿é—´</h2>
            <div>
                <input type="text" id="room3" placeholder="æˆ¿é—´å·" value="test-pwd-001">
                <input type="text" id="nick3" placeholder="æ˜µç§°" value="è®¿å®¢Charlie">
                <input type="password" id="pwd3" placeholder="æˆ¿é—´å¯†ç " value="wrongpwd">
                <button onclick="joinWithWrongPassword()">ç”¨é”™è¯¯å¯†ç åŠ å…¥</button>
            </div>
            <div id="result3" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•åœºæ™¯4ï¼šæ£€æŸ¥æˆ¿é—´è®¾ç½®ä¿å­˜</h2>
            <button onclick="checkSavedConfig()">æ£€æŸ¥ä¿å­˜çš„æˆ¿é—´é…ç½®</button>
            <div id="result4" class="log-area"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•åœºæ™¯5ï¼šæˆ¿é—´äººæ•°é™åˆ¶</h2>
            <div>
                <input type="text" id="room5" placeholder="æˆ¿é—´å·" value="test-limit-001">
                <input type="number" id="maxUsers" placeholder="æœ€å¤§äººæ•°" value="2" min="1" max="50">
                <button onclick="testUserLimit()">æµ‹è¯•äººæ•°é™åˆ¶</button>
            </div>
            <div id="result5" class="log-area"></div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        function log(resultId, message, type = 'info') {
            const resultDiv = document.getElementById(resultId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            resultDiv.innerHTML += `<div class="status ${statusClass}">[${timestamp}] ${message}</div>\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function createPasswordRoom() {
            const roomId = document.getElementById('room1').value;
            const nickname = document.getElementById('nick1').value;
            const password = document.getElementById('pwd1').value;

            log('result1', `æ­£åœ¨åˆ›å»ºå¯†ç ä¿æŠ¤æˆ¿é—´: ${roomId}`, 'info');

            // æ¨¡æ‹Ÿåˆ›å»ºæˆ¿é—´é…ç½®
            const roomConfig = {
                roomId: roomId,
                createdBy: nickname,
                password: password,
                isPrivate: true,
                hasPassword: true,
                maxUsers: 20,
                category: 'chat',
                createdAt: Date.now()
            };

            // ä¿å­˜åˆ°localStorage
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            roomConfigs[roomId] = roomConfig;
            localStorage.setItem('mqtt_room_configs', JSON.stringify(roomConfigs));

            log('result1', `âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼å¯†ç : ${password}`, 'success');
            log('result1', `é…ç½®å·²ä¿å­˜åˆ°localStorage`, 'info');
        }

        function joinWithCorrectPassword() {
            const roomId = document.getElementById('room2').value;
            const nickname = document.getElementById('nick2').value;
            const password = document.getElementById('pwd2').value;

            log('result2', `å°è¯•ç”¨å¯†ç  "${password}" åŠ å…¥æˆ¿é—´: ${roomId}`, 'info');

            // ä»localStorageè¯»å–æˆ¿é—´é…ç½®
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            const roomConfig = roomConfigs[roomId];

            if (!roomConfig) {
                log('result2', `âŒ æˆ¿é—´ "${roomId}" ä¸å­˜åœ¨ï¼`, 'error');
                return;
            }

            if (roomConfig.isPrivate && roomConfig.password) {
                if (password === roomConfig.password) {
                    log('result2', `âœ… å¯†ç æ­£ç¡®ï¼æˆåŠŸåŠ å…¥æˆ¿é—´`, 'success');
                    log('result2', `æ¬¢è¿ ${nickname} åŠ å…¥æˆ¿é—´`, 'info');
                } else {
                    log('result2', `âŒ å¯†ç é”™è¯¯ï¼æ— æ³•åŠ å…¥æˆ¿é—´`, 'error');
                }
            } else {
                log('result2', `æˆ¿é—´æ— å¯†ç ä¿æŠ¤ï¼Œç›´æ¥åŠ å…¥`, 'info');
            }
        }

        function joinWithWrongPassword() {
            const roomId = document.getElementById('room3').value;
            const nickname = document.getElementById('nick3').value;
            const password = document.getElementById('pwd3').value;

            log('result3', `å°è¯•ç”¨å¯†ç  "${password}" åŠ å…¥æˆ¿é—´: ${roomId}`, 'info');

            // ä»localStorageè¯»å–æˆ¿é—´é…ç½®
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            const roomConfig = roomConfigs[roomId];

            if (!roomConfig) {
                log('result3', `âŒ æˆ¿é—´ "${roomId}" ä¸å­˜åœ¨ï¼`, 'error');
                return;
            }

            if (roomConfig.isPrivate && roomConfig.password) {
                if (password === roomConfig.password) {
                    log('result3', `âœ… å¯†ç æ­£ç¡®ï¼æˆåŠŸåŠ å…¥æˆ¿é—´`, 'success');
                } else {
                    log('result3', `âŒ å¯†ç é”™è¯¯ï¼æ­£ç¡®å¯†ç åº”è¯¥æ˜¯: ${roomConfig.password}`, 'error');
                    log('result3', `æ‹’ç»è®¿é—®`, 'error');
                }
            }
        }

        function checkSavedConfig() {
            log('result4', 'æ£€æŸ¥localStorageä¸­çš„æˆ¿é—´é…ç½®...', 'info');

            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');

            if (Object.keys(roomConfigs).length === 0) {
                log('result4', 'æ²¡æœ‰ä¿å­˜çš„æˆ¿é—´é…ç½®', 'info');
                return;
            }

            for (const [roomId, config] of Object.entries(roomConfigs)) {
                log('result4', `æˆ¿é—´: ${roomId}`, 'info');
                log('result4', `  - åˆ›å»ºè€…: ${config.createdBy}`, 'info');
                log('result4', `  - æœ‰å¯†ç : ${config.hasPassword ? 'æ˜¯' : 'å¦'}`, 'info');
                if (config.password) {
                    log('result4', `  - å¯†ç : ${config.password}`, 'info');
                }
                log('result4', `  - æœ€å¤§äººæ•°: ${config.maxUsers || 'æœªè®¾ç½®'}`, 'info');
                log('result4', `  - ç±»åˆ«: ${config.category || 'æœªè®¾ç½®'}`, 'info');
                log('result4', `  - åˆ›å»ºæ—¶é—´: ${new Date(config.createdAt).toLocaleString()}`, 'info');
            }
        }

        function testUserLimit() {
            const roomId = document.getElementById('room5').value;
            const maxUsers = parseInt(document.getElementById('maxUsers').value);

            log('result5', `åˆ›å»ºæˆ¿é—´ "${roomId}"ï¼Œæœ€å¤§äººæ•°: ${maxUsers}`, 'info');

            // åˆ›å»ºæˆ¿é—´é…ç½®
            const roomConfig = {
                roomId: roomId,
                createdBy: 'æˆ¿ä¸»',
                maxUsers: maxUsers,
                createdAt: Date.now()
            };

            // ä¿å­˜é…ç½®
            const roomConfigs = JSON.parse(localStorage.getItem('mqtt_room_configs') || '{}');
            roomConfigs[roomId] = roomConfig;
            localStorage.setItem('mqtt_room_configs', JSON.stringify(roomConfigs));

            // æ¨¡æ‹Ÿç”¨æˆ·åŠ å…¥
            const onlineUsers = new Set();
            for (let i = 1; i <= maxUsers + 1; i++) {
                if (onlineUsers.size >= maxUsers) {
                    log('result5', `âŒ ç”¨æˆ·${i} æ— æ³•åŠ å…¥ï¼šæˆ¿é—´å·²æ»¡ï¼ˆ${maxUsers}/${maxUsers}ï¼‰`, 'error');
                } else {
                    onlineUsers.add(`ç”¨æˆ·${i}`);
                    log('result5', `âœ… ç”¨æˆ·${i} æˆåŠŸåŠ å…¥ï¼ˆ${onlineUsers.size}/${maxUsers}ï¼‰`, 'success');
                }
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ¸…ç†æµ‹è¯•æ•°æ®
        window.onload = function() {
            log('result1', 'æµ‹è¯•ç¯å¢ƒå‡†å¤‡å°±ç»ª', 'info');
        };
    </script>
</body>
</html>