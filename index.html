<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>虚拟手机</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="虚拟手机">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23667eea' rx='40'/%3E%3Ctext x='90' y='110' font-size='80' text-anchor='middle' fill='white'%3E📱%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mobile-container">
        <main id="home-screen" class="screen">
            <h1>主页</h1>
            <p>
                <span id="player-name-display" onclick="WorldBookV2.editPlayerName()" style="cursor:pointer;text-decoration:underline;">你</span>
                好，我是 
                <span id="ai-name-display">...</span>
            </p>
               <div class="app-grid">
                <div class="app-icon" id="open-chat-app"><div class="app-icon-bg">💬</div><span class="app-name">聊天</span></div>
                <div class="app-icon" id="open-mqtt-room-app"><div class="app-icon-bg">🌐</div><span class="app-name">聊天室</span></div>
                <div class="app-icon" id="open-wallet-app"><div class="app-icon-bg">💰</div><span class="app-name">钱包</span></div>
                <div class="app-icon" id="open-store-app"><div class="app-icon-bg">🛒</div><span class="app-name">商店</span></div>
                <div class="app-icon" id="open-backpack-app"><div class="app-icon-bg">🎒</div><span class="app-name">背包</span></div>
                <div class="app-icon" id="open-world-book-app"><div class="app-icon-bg">📖</div><span class="app-name">世界书</span></div>
                <div class="app-icon" id="open-settings-app"><div class="app-icon-bg">⚙️</div><span class="app-name">API设置</span></div>
                <div class="app-icon" id="open-general-settings-app"><div class="app-icon-bg">🔧</div><span class="app-name">通用设置</span></div>
            </div> <!-- app-grid 结束 -->

            <!-- 变量替换 Demo（只在首页显示） -->
            <details id="vars-demo" style="margin-top:14px;">
              <summary>变量调试面板</summary>
              <div style="padding:10px;border:1px dashed #bbb;border-radius:8px;font-size:14px;">
                <div><strong>模板（原文）</strong>：
                  现在是 {{time.hour}}:{{time.minute}}，{{ai.name}} 心情 {{ai.mood}}。
                  你有 {{player.inventory.length:0}} 件物品，聊天条数：{{chat.count}}，
                  离线收益/分：{{worldBook.rule001.value:1}}，随机数：{{random.10}}
                </div>
                <div style="margin-top:8px;"><strong>渲染结果</strong>：
                  <span id="vars-demo-result">（加载中…）</span>
                </div>
              </div>
            </details>
        </main>
        
        <section id="chat-screen" class="screen">
            <header class="chat-header"><button id="back-to-home-btn" class="back-btn">‹</button><h2 id="chat-header-title">与零的聊天</h2></header>
            <div id="message-container" class="message-container"></div>
            <form id="chat-input-form" class="chat-input-form">
                <button type="button" id="send-image-btn" class="chat-action-btn">📷</button>
                <input type="text" id="chat-input" placeholder="输入消息...">
                <button type="submit">发送</button>
            </form>
            <input type="file" id="image-input" accept="image/*" style="display: none;">
        </section>

        <section id="wallet-screen" class="screen">
            <header class="wallet-header">
                <button id="wallet-back-btn" class="back-btn">‹</button>
                <h2>我的钱包</h2>
                <button id="wallet-refresh-btn" title="刷新余额">↻</button>
            </header>
            <div class="wallet-content">
                <div class="balance-card">
                    <h3>你的余额</h3>
                    <p><span id="player-money-display">0</span> 金币</p>
                </div>
                <div class="balance-card">
                    <h3><span id="ai-name-wallet-display">AI</span>的余额</h3>
                    <p><span id="ai-money-display">0</span> 金币</p>
                </div>
            </div>
        </section>
        <section id="store-screen" class="screen"> <header class="store-header"><button id="store-back-btn" class="back-btn">‹</button><h2>商店</h2></header> <div class="store-content"><p>你的余额: <span id="store-player-money-display">0</span> 金币</p><div id="item-list" class="item-list"></div></div> </section>
        <section id="backpack-screen" class="screen"> <header class="backpack-header"><button id="backpack-back-btn" class="back-btn">‹</button><h2>我的背包</h2></header> <div id="inventory-list" class="inventory-list"></div> </section>
        
<section id="world-book-screen" class="screen">
    <header class="world-book-header">
        <button id="world-book-back-btn" class="back-btn">‹</button>
        <h2>世界书</h2>
    </header>
    
    <!-- 简约主界面 -->
    <div class="wb-container">
        <!-- 极简顶部栏 -->
        <div class="wb-minimal-top">
            <select id="wb-current-book" class="wb-select-minimal">
                <option value="">选择世界书...</option>
            </select>
            <div class="wb-top-actions">
                <button class="wb-mini-btn" onclick="WorldBookV2.createNewBook()" title="新建世界书">➕</button>
                <button class="wb-mini-btn" onclick="WorldBookV2.editBookSettings()" title="世界书设置">📚</button>
                <button onclick="WorldBookV2.toggleGlobalSettings()" id="wb-global-settings-btn" title="全局激活设置">⚙️ 全局设置</button>
            </div>
        </div>

        <!-- 全局世界书激活设置面板 -->
        <div id="wb-global-settings" class="wb-global-settings" style="display: none;">
            <div class="wb-settings-header">
                <span>全局世界信息/知识书激活设置</span>
                <button onclick="WorldBookV2.toggleGlobalSettings()" class="wb-close-btn">×</button>
            </div>
            
            <!-- 基础设置 -->
            <div class="wb-settings-section">
                <div class="wb-settings-row">
                    <div class="wb-setting-item">
                        <label>扫描深度</label>
                        <input type="number" id="wb-scan-depth" min="0" max="100" value="2">
                        <small>回溯消息数量</small>
                    </div>
                    <div class="wb-setting-item">
                        <label>上下文百分比</label>
                        <input type="number" id="wb-context-percent" min="0" max="100" value="25">
                        <small>占用上下文%</small>
                    </div>
                </div>
                
                <div class="wb-settings-row">
                    <div class="wb-setting-item">
                        <label>Token预算上限 ℹ️</label>
                        <input type="number" id="wb-token-budget" min="0" max="8192" value="2048">
                        <small>最大Token数</small>
                    </div>
                    <div class="wb-setting-item">
                        <label>最小激活数 ⚠️</label>
                        <input type="number" id="wb-min-activations" min="0" max="100" value="0">
                        <small>最少触发条目</small>
                    </div>
                </div>
            </div>
            
            <!-- 高级设置（可折叠） -->
            <details class="wb-advanced-settings">
                <summary>🔧 高级递归与匹配设置</summary>
                <div class="wb-settings-section">
                    <div class="wb-settings-row">
                        <div class="wb-setting-item">
                            <label>最大递归深度 ⚠️</label>
                            <input type="number" id="wb-max-recursion" min="0" max="10" value="2">
                            <small>递归层数限制</small>
                        </div>
                        <div class="wb-setting-item">
                            <label>最大深度 ⚠️</label>
                            <input type="number" id="wb-max-depth" min="0" max="999" value="100">
                            <small>最大扫描深度</small>
                        </div>
                    </div>
                    
                    <div class="wb-settings-row">
                        <div class="wb-setting-item full-width">
                            <label>插入策略</label>
                            <select id="wb-insertion-strategy">
                                <option value="evenly">角色世界书优先</option>
                                <option value="character_first">角色优先</option>
                                <option value="global_first">全局优先</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="wb-checkbox-group">
                        <label><input type="checkbox" id="wb-include-names" checked> 包括名称</label>
                        <label><input type="checkbox" id="wb-recursive-scan" checked> 递归扫描</label>
                        <label><input type="checkbox" id="wb-case-sensitive"> 区分大小写</label>
                        <label><input type="checkbox" id="wb-match-whole-words"> 匹配整个单词</label>
                        <label><input type="checkbox" id="wb-use-group-scoring"> 使用群组评分</label>
                        <label><input type="checkbox" id="wb-overflow-alert" checked> 溢出警报</label>
                        <label title="启用后将Token预算分配到不同位置桶"><input type="checkbox" id="wb-use-bucket-allocation"> 启用分桶配额</label>
                    </div>

                    <!-- 分桶配额设置（仅在启用时显示） -->
                    <div id="wb-bucket-settings" style="display:none; margin-top:15px; padding:10px; background:#f8f9fa; border-radius:8px;">
                        <label style="font-size:13px; font-weight:600; color:#666;">分桶配额比例设置</label>
                        <div class="wb-settings-row" style="margin-top:10px;">
                            <div class="wb-setting-item">
                                <label>前端 (系统/角色)</label>
                                <input type="number" id="wb-bucket-top" min="0" max="100" value="40">
                                <small>%</small>
                            </div>
                            <div class="wb-setting-item">
                                <label>示例</label>
                                <input type="number" id="wb-bucket-example" min="0" max="100" value="15">
                                <small>%</small>
                            </div>
                            <div class="wb-setting-item">
                                <label>末端 (作者注/深度)</label>
                                <input type="number" id="wb-bucket-end" min="0" max="100" value="45">
                                <small>%</small>
                            </div>
                        </div>
                        <small style="color:#999; font-size:11px;">提示：三个比例之和应该等于100%</small>
                    </div>
                </div>
            </details>
            
            <div class="wb-settings-footer">
                <button onclick="WorldBookV2.saveGlobalSettings()" class="wb-save-btn">保存设置</button>
                <button onclick="WorldBookV2.resetGlobalSettings()" class="wb-reset-btn">重置默认</button>
            </div>
        </div>

        <!-- 搜索栏 -->
        <div class="wb-search-bar">
            <input type="text" id="wb-search" class="wb-search-minimal" placeholder="搜索条目...">
            <button class="wb-add-btn" onclick="WorldBookV2.addEntry()">+ 新条目</button>
        </div>

        <!-- 模式切换栏 -->
        <div class="wb-mode-bar" id="wb-mode-bar" style="display:none;">
            <button class="wb-mode-btn" id="wb-toggle-mode" onclick="WorldBookV2.toggleMode()">
                <span class="mode-icon">☰</span>
                <span class="mode-text">多选</span>
            </button>
            <div class="wb-mode-info" id="wb-mode-info" style="display:none;">
                <label class="wb-switch">
                    <input type="checkbox" id="wb-select-all" onchange="WorldBookV2.toggleSelectAll()">
                    <span>全选</span>
                </label>
                <span id="wb-selected-count" style="margin-left:10px;font-size:13px;color:#666;">已选: 0</span>
            </div>
        </div>

        <!-- 批量操作栏（仅在多选模式显示） -->
        <div class="wb-batch-bar" id="wb-batch-bar" style="display:none;">
            <div class="wb-batch-actions">
                <button class="wb-batch-btn" onclick="WorldBookV2.batchEnable(true)">启用</button>
                <button class="wb-batch-btn" onclick="WorldBookV2.batchEnable(false)">禁用</button>
                <button class="wb-batch-btn danger" onclick="WorldBookV2.batchDelete()">删除</button>
                <button class="wb-batch-btn" onclick="WorldBookV2.exitMultiSelect()">取消</button>
            </div>
        </div>

        <!-- 条目列表（极简卡片） -->
        <div class="wb-entries-list" id="wb-entries-list">
            <!-- 条目将在这里渲染 -->
        </div>
        
        <!-- 空状态 -->
        <div class="wb-empty" id="wb-empty-state" style="display:none;">
            <div class="wb-empty-icon">📖</div>
            <p>暂无条目</p>
            <button class="wb-empty-btn" onclick="WorldBookV2.addEntry()">创建第一个条目</button>
        </div>
    </div>
</section>

<!-- 条目编辑面板（重新设计） -->
<div id="wb-entry-panel" class="wb-panel">
    <div class="wb-panel-overlay" onclick="WorldBookV2.closePanel()"></div>
    <div class="wb-panel-content">
        <!-- 顶部标题栏 -->
        <div class="wb-panel-header">
            <input type="text" id="entry-name" class="wb-entry-title-input" placeholder="条目标题">
            <div class="wb-panel-buttons">
                <button class="wb-panel-btn" onclick="WorldBookV2.importEntry()" title="导入">📥</button>
                <button class="wb-panel-btn" onclick="WorldBookV2.exportEntry()" title="导出">📤</button>
                <button class="wb-panel-btn" onclick="WorldBookV2.deleteEntry()" title="删除">🗑️</button>
                <button class="wb-panel-btn" onclick="WorldBookV2.closePanel()" title="关闭">✖️</button>
            </div>
        </div>
        
        <!-- ID字段 -->
        <div class="wb-panel-field">
            <input type="text" id="entry-id" class="wb-input-minimal" placeholder="条目ID（唯一标识符）">
        </div>
        
        <div class="wb-panel-body">
            <!-- ①常驻和选择性触发 -->
            <div class="wb-switches">
                <label class="wb-switch">
                    <input type="checkbox" id="entry-constant">
                    <span>常驻</span>
                </label>
                <label class="wb-switch">
                    <input type="checkbox" id="entry-selective">
                    <span>选择性触发</span>
                </label>
            </div>
            
            <!-- ②触发关键词 -->
            <div class="wb-field">
                <label class="wb-label">触发关键词</label>
                <input type="text" id="entry-keys" class="wb-input" placeholder="关键词1, 关键词2, /正则/"> 
            </div>
            
            <!-- 可选关键词（可折叠） -->
            <details class="wb-collapsible">
                <summary>可选关键词</summary>
                
                <!-- ③触发条件 -->
                <div class="wb-field">
                    <label class="wb-label">触发条件（逻辑）</label>
                    <select id="entry-logic" class="wb-select">
                        <option value="AND_ANY">AND ANY（任一关键词）</option>
                        <option value="AND_ALL">AND ALL（所有关键词）</option>
                        <option value="NOT_ANY">NOT ANY（排除任一）</option>
                        <option value="NOT_ALL">NOT ALL（排除所有）</option>
                    </select>
                </div>
                
                <!-- ④辅助关键词 -->
                <div class="wb-field">
                    <label class="wb-label">辅助关键词</label>
                    <input type="text" id="entry-secondary-keys" class="wb-input" placeholder="额外的触发词">
                </div>
            </details>
            
            <!-- ⑤内容 -->
            <div class="wb-field">
                <label class="wb-label">
                    内容
                    <button class="wb-expand-btn" onclick="WorldBookV2.expandContent()" title="放大编辑">🔍</button>
                </label>
                <textarea id="entry-content" class="wb-textarea" rows="4" placeholder="当触发时注入的内容..." oninput="WorldBookV2.updatePreview()"></textarea>
                
                <!-- 实时预览 -->
                <details class="wb-preview-box" style="margin-top:8px;">
                    <summary style="font-size:12px;color:#666;">📝 实时预览（变量替换）</summary>
                    <div id="content-preview" style="padding:8px;background:#f8f9fa;border-radius:6px;font-size:13px;line-height:1.5;margin-top:4px;color:#333;">
                        在上方输入内容...
                    </div>
                </details>
            </div>
            
            <!-- 高级设置（可折叠） -->
            <details class="wb-collapsible">
                <summary>高级设置</summary>
                
                <div class="wb-grid-2">
                    <!-- ⑥优先级 -->
                    <div class="wb-field">
                        <label class="wb-label">优先级</label>
                        <input type="number" id="entry-order" class="wb-input" value="100" min="0">
                    </div>
                    
                    <!-- ⑦位置 -->
                    <div class="wb-field">
                        <label class="wb-label">位置</label>
                        <select id="entry-position" class="wb-select">
                            <option value="before_char">角色定义前</option>
                            <option value="after_char">角色定义后</option>
                            <option value="before_example">示例消息前</option>
                            <option value="after_example">示例消息后</option>
                            <option value="before_an">作者注释前</option>
                            <option value="after_an">作者注释后</option>
                            <option value="depth_system">@Depth ⚙️系统</option>
                            <option value="depth_user">@Depth 👤用户</option>
                            <option value="depth_assistant">@Depth 🤖AI</option>
                        </select>
                    </div>
                    
                    <!-- ⑧深度 -->
                    <div class="wb-field">
                        <label class="wb-label">深度</label>
                        <input type="number" id="entry-depth" class="wb-input" value="4" min="0">
                    </div>
                    
                    <!-- ⑨概率 -->
                    <div class="wb-field">
                        <label class="wb-label">概率 <span id="prob-value">100%</span></label>
                        <input type="range" id="entry-probability" class="wb-range" min="0" max="100" value="100">
                    </div>
                </div>
                
                <!-- ⑩时序 -->
                <div class="wb-field">
                    <label class="wb-label">时序控制</label>
                    <div class="wb-grid-3">
                        <input type="number" id="entry-sticky" class="wb-input" placeholder="粘性" min="0">
                        <input type="number" id="entry-cooldown" class="wb-input" placeholder="冷却" min="0">
                        <input type="number" id="entry-delay" class="wb-input" placeholder="延迟" min="0">
                    </div>
                </div>
            </details>
            
            <!-- 递归扫描（可折叠） -->
            <details class="wb-collapsible">
                <summary>递归扫描</summary>
                
                <div class="wb-switches">
                    <label class="wb-switch">
                        <input type="checkbox" id="entry-disable-recursion">
                        <span>禁用递归</span>
                    </label>
                    <label class="wb-switch">
                        <input type="checkbox" id="entry-scan-depth">
                        <span>延伸扫描</span>
                    </label>
                </div>
                
                <div class="wb-field">
                    <label class="wb-label">递归深度</label>
                    <input type="number" id="entry-recursion-depth" class="wb-input" value="2" min="0" max="10">
                </div>
            </details>
            
            <!-- 其他（可折叠） -->
            <details class="wb-collapsible">
                <summary>其他</summary>
                
                <!-- 激活设置 -->
                <div class="wb-field">
                    <label class="wb-label">激活设置</label>
                    <div class="wb-grid-2">
                        <input type="number" id="entry-scan-depth-val" class="wb-input" placeholder="扫描深度" min="0">
                        <input type="number" id="entry-token-budget" class="wb-input" placeholder="Token预算" min="0">
                    </div>
                </div>
                
                <!-- 匹配规则 -->
                <div class="wb-switches">
                    <label class="wb-switch">
                        <input type="checkbox" id="entry-case-sensitive">
                        <span>区分大小写</span>
                    </label>
                    <label class="wb-switch">
                        <input type="checkbox" id="entry-whole-words">
                        <span>全词匹配</span>
                    </label>
                </div>
                
                <!-- 说话者限制（占位） -->
                <div class="wb-field">
                    <label class="wb-label">说话者限制（占位）</label>
                    <select id="entry-speaker" class="wb-select" disabled>
                        <option>任意</option>
                        <option>用户</option>
                        <option>AI</option>
                    </select>
                </div>
                
                <!-- 绑定设置 -->
                <div class="wb-field">
                    <label class="wb-label">条目绑定 <span style="font-size:11px;color:#999">(留空=继承世界书设置)</span></label>
                    <div class="wb-switches">
                        <label class="wb-switch">
                            <input type="radio" name="entry-bind-type" id="entry-bind-inherit" value="inherit" checked onchange="WorldBookV2.toggleBindType()">
                            <span>📖 继承</span>
                        </label>
                        <label class="wb-switch">
                            <input type="radio" name="entry-bind-type" id="entry-bind-global" value="global" onchange="WorldBookV2.toggleBindType()">
                            <span>🌍 全局</span>
                        </label>
                        <label class="wb-switch">
                            <input type="radio" name="entry-bind-type" id="entry-bind-character" value="character" onchange="WorldBookV2.toggleBindType()">
                            <span>👤 角色</span>
                        </label>
                    </div>
                    
                    <!-- 角色多选 -->
                    <div id="character-select-container" style="display:none;margin-top:8px;">
                        <div style="font-size:12px;color:#666;margin-bottom:8px;">选择角色：</div>
                        
                        <!-- 下拉选择框 -->
                        <div style="display:flex;gap:8px;margin-bottom:8px;">
                            <select id="character-dropdown" class="wb-select" style="flex:1;">
                                <option value="">选择要绑定的角色...</option>
                            </select>
                            <button class="wb-btn-secondary" onclick="WorldBookV2.addSelectedCharacter()" style="padding:8px 16px;">添加</button>
                        </div>
                        
                        <!-- 已选择的角色标签 -->
                        <div id="selected-characters-container" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;padding:8px;background:#f8f9fa;border-radius:6px;">
                            <!-- 动态生成标签 -->
                        </div>
                        
                        <div style="margin-top:8px;">
                            <label class="wb-switch">
                                <input type="checkbox" id="entry-exclude-mode">
                                <span>排除模式（反选）</span>
                            </label>
                        </div>
                    </div>
                </div>
            </details>
        </div>
        
        <!-- 底部按钮 -->
        <div class="wb-panel-footer">
            <button class="wb-btn-save" onclick="WorldBookV2.saveEntry()">保存条目</button>
            <button class="wb-btn-test" onclick="WorldBookV2.testEntry()">沙盒测试</button>
        </div>
    </div>
</div>

<!-- 内容编辑放大对话框 -->
<div id="wb-content-expand" class="wb-modal" style="display:none;">
    <div class="wb-modal-content">
        <div class="wb-modal-header">
            <h3>编辑内容</h3>
            <button class="wb-modal-close" onclick="WorldBookV2.closeExpandContent()">✖️</button>
        </div>
        <div class="wb-modal-body">
            <textarea id="expand-content" class="wb-expand-textarea" placeholder="在这里编辑内容..."></textarea>
        </div>
        <div class="wb-modal-footer">
            <button class="wb-btn-primary" onclick="WorldBookV2.saveExpandContent()">确定</button>
        </div>
    </div>
</div>

<!-- 世界书设置（简化版） -->
<div id="wb-book-settings" class="wb-modal" style="display: none;">
    <div class="wb-modal-content">
        <div class="wb-modal-header">
            <h3>世界书设置</h3>
            <button class="wb-modal-close" onclick="WorldBookV2.closeBookSettings()">✖️</button>
        </div>
        <div class="wb-modal-body">
            <div class="wb-field">
                <label class="wb-label">世界书名称</label>
                <input type="text" id="book-name" class="wb-input" placeholder="例如：奇幻世界设定">
            </div>
            <div class="wb-field">
                <label class="wb-label">描述</label>
                <textarea id="book-description" rows="3" class="wb-textarea" placeholder="这本世界书的用途说明..."></textarea>
            </div>
            <div class="wb-field">
                <label class="wb-label">作用域</label>
                <select id="book-scope" class="wb-select" onchange="WorldBookV2.toggleCharacterSelection()">
                    <option value="global">🌍 全局（对所有角色生效）</option>
                    <option value="character">👥 绑定角色（仅对选中角色生效）</option>
                </select>
            </div>

            <!-- 角色选择区域（仅在选择"绑定角色"时显示） -->
            <div id="book-character-selection" class="wb-field" style="display:none;">
                <label class="wb-label">选择要绑定的角色</label>
                <div id="book-characters-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px;">
                    <!-- 动态生成角色复选框 -->
                </div>
            </div>

            <hr style="margin: 15px 0; border: none; border-top: 1px solid #e2e8f0;">

            <div class="wb-field">
                <label class="wb-label">📥 导入世界书</label>
                <button class="wb-btn-secondary" onclick="WorldBookV2.importBook()">选择文件</button>
            </div>

            <div class="wb-field">
                <label class="wb-label">📤 导出世界书</label>
                <button class="wb-btn-secondary" onclick="WorldBookV2.exportBook()">导出为JSON</button>
            </div>
        </div>
        <div class="wb-modal-footer">
            <button class="wb-btn-primary" onclick="WorldBookV2.saveBookSettings()">保存</button>
            <button class="wb-btn-secondary" onclick="WorldBookV2.closeBookSettings()">取消</button>
            <button class="wb-btn-danger" onclick="WorldBookV2.deleteBook()">删除世界书</button>
        </div>
    </div>
</div>

<!-- 测试沙盒 -->
<div id="wb-test-dialog" class="wb-modal" style="display:none;">
    <div class="wb-modal-content">
        <div class="wb-modal-header">
            <h3>沙盒测试</h3>
            <button class="wb-modal-close" onclick="WorldBookV2.closeTestDialog()">✖️</button>
        </div>
        <div class="wb-modal-body">
            <div class="wb-field">
                <label>测试文本</label>
                <textarea id="test-text" class="wb-textarea" rows="3" placeholder="输入测试文本..."></textarea>
            </div>
            <button class="wb-btn-primary" onclick="WorldBookV2.runTest()">运行测试</button>
            <div id="test-results" class="wb-test-results" style="display:none;">
                <h4>测试结果</h4>
                <div id="test-matches"></div>
            </div>
        </div>
    </div>
</div>
<section id="settings-screen" class="screen">
            <header class="settings-header">
                <button id="settings-back-btn" class="back-btn">‹</button>
                <h2>API 设置</h2>
            </header>
            <div class="settings-content">
                <div class="form-group preset-manager">
                    <label for="api-preset-select">API 预设</label>
                    <div class="preset-controls">
                        <select id="api-preset-select"></select>
                        <button id="new-preset-btn" class="preset-btn">+</button>
                        <button id="delete-preset-btn" class="preset-btn">-</button>
                    </div>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label for="preset-name-input">预设名称</label>
                    <input type="text" id="preset-name-input" placeholder="例如：我的Gemini">
                </div>
                <div class="form-group">
                    <label for="api-provider-select">API 服务商</label>
                    <select id="api-provider-select">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                        <option value="openai-compatible">OpenAI 兼容 (中转)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="api-endpoint-input">API 地址 / 中转站</label>
                    <input type="text" id="api-endpoint-input" placeholder="例如：https://api.openai.com/v1/chat/completions">
                </div>
                <div class="form-group">
                    <label for="api-key-input">API 密钥</label>
                    <input type="password" id="api-key-input" placeholder="在此输入你的密钥">
                </div>
                <div class="form-group">
                    <label for="api-model-input">模型名称</label>
                    <input list="api-models-list" id="api-model-input" name="model" placeholder="点击选择或手动输入...">
                    <datalist id="api-models-list"></datalist>
                    <button id="fetch-models-btn" class="form-button-secondary" style="margin-top: 10px;">拉取可用模型</button>
                </div>
                <div class="api-test-container">
                    <button id="test-api-btn" class="form-button-secondary">测试连接</button>
                    <span id="api-status-indicator"></span>
                </div>
                <button id="save-settings-btn" class="form-button">保存当前预设</button>
                <hr class="separator">
                <div class="form-group">
                    <label>世界书管理</label>
                    <button id="wi-btn" type="button" class="form-button-secondary">导入世界书</button>
                    <input id="wi-import" type="file" accept="application/json" style="display:none"/>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label>数据备份与恢复</label>
                    <button id="export-data-btn" class="form-button-secondary">导出备份文件</button>
                    <button id="import-data-btn" class="form-button-secondary" style="margin-top: 10px;">导入备份文件</button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                </div>
            </div>
        </section>

        <section id="general-settings-screen" class="screen">
            <header class="settings-header">
                <button id="general-settings-back-btn" class="back-btn">‹</button>
                <h2>通用设置</h2>
            </header>
            <div class="settings-content">
                <div class="form-group">
                    <label for="ai-persona-textarea">AI 核心性格 (AI Persona)</label>
                    <textarea id="ai-persona-textarea" rows="4" placeholder="定义AI的性格、背景故事、说话风格..."></textarea>
                </div>
                <div class="form-group">
                    <label for="my-persona-textarea">我的虚拟形象 (My Persona)</label>
                    <textarea id="my-persona-textarea" rows="3" placeholder="告诉AI，你希望它如何看待你..."></textarea>
                </div>
                <hr class="separator">
                <div class="form-group">
                    <label>关联世界书 (为当前聊天)</label>
                    <div id="world-book-linking-container" style="padding: 10px; background: #f0f0f0; border-radius: 6px; min-height: 50px;">
                    </div>
                </div>
                 <hr class="separator">
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                    <label for="chain-of-thought-switch" style="margin-bottom: 0;">启用思维链（让AI后台思考）</label>
                    <input type="checkbox" id="chain-of-thought-switch" style="width: auto; height: 20px;">
                </div>
                <div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: -10px; padding-left: 20px;">
                    <label for="show-thought-alert-switch" style="margin-bottom: 0; font-size: 13px; color: #666;">显示思维过程（弹窗+对话框）</label>
                    <input type="checkbox" id="show-thought-alert-switch" style="width: auto; height: 18px;">
                </div>
                  <button id="save-general-settings-btn" class="form-button">保存通用设置</button>
                  <button id="debug-settings-btn" class="form-button-secondary" style="margin-top: 10px;">调试设置状态</button>
                  <button id="fix-data-btn" class="form-button-secondary" style="margin-top: 10px;">修复数据兼容性</button>
                  <button id="clean-thought-btn" class="form-button-secondary" style="margin-top: 10px;">清理思维链显示问题</button>
              </div>
          </section>

        <section id="mqtt-room-screen" class="screen">
            <div id="mqtt-room-container"></div>
        </section>
                <section id="lock-screen" class="screen">
            <div class="time-display">10:24</div>
            <div class="unlock-prompt">点击屏幕以解锁</div>
        </section>
    </div>

   <!-- 模块化的脚本引入 -->
    <!-- 核心模块 -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/database.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/ai.js"></script>
    
    <!-- 界面模块 -->
    <script src="js/screens/chat.js"></script>
    <script src="js/screens/wallet.js"></script>
    <script src="js/screens/store.js"></script>
    <script src="js/screens/backpack.js"></script>
    <script src="js/screens/worldbook.js"></script>
    <script src="js/screens/settings.js"></script>
    <script src="js/screens/general-settings.js"></script>
    <script src="js/screens/mqtt-room.js"></script>

    <!-- 主入口（必须最后加载） -->
    <script src="js/main.js"></script>

    <!-- WorldBook 引擎集成 -->
    <script src="/worldbook/index.iife.js"></script>
    <script src="/js/worldbook-link.js"></script>
    
    <script>
    // 注册Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').then(reg => {
            console.log('Service Worker registered');
        });
    }
    </script>
</body>
</html>
