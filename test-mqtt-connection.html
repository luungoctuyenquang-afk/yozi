<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTè¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        .test-group {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ MQTTè¿æ¥è°ƒè¯•å·¥å…·</h1>

        <div class="test-group">
            <h2>æµ‹è¯•1ï¼šåŸºç¡€è¿æ¥æµ‹è¯•</h2>
            <button onclick="testBasicConnection()">æµ‹è¯•åŸºç¡€è¿æ¥</button>
            <div id="status1" class="status disconnected">æœªè¿æ¥</div>
            <div id="log1" class="log">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-group">
            <h2>æµ‹è¯•2ï¼šåˆ›å»ºæ— å¯†ç æˆ¿é—´</h2>
            <input type="text" id="room2" placeholder="æˆ¿é—´å·" value="test-room-001">
            <input type="text" id="nick2" placeholder="æ˜µç§°" value="æµ‹è¯•ç”¨æˆ·1">
            <button onclick="createNormalRoom()">åˆ›å»ºæˆ¿é—´</button>
            <div id="status2" class="status disconnected">æœªè¿æ¥</div>
            <div id="log2" class="log">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-group">
            <h2>æµ‹è¯•3ï¼šåŠ å…¥æ— å¯†ç æˆ¿é—´</h2>
            <input type="text" id="room3" placeholder="æˆ¿é—´å·" value="test-room-001">
            <input type="text" id="nick3" placeholder="æ˜µç§°" value="æµ‹è¯•ç”¨æˆ·2">
            <button onclick="joinNormalRoom()">åŠ å…¥æˆ¿é—´</button>
            <div id="status3" class="status disconnected">æœªè¿æ¥</div>
            <div id="log3" class="log">ç­‰å¾…æµ‹è¯•...</div>
        </div>

        <div class="test-group">
            <h2>æ¸…ç†æµ‹è¯•æ•°æ®</h2>
            <button onclick="clearTestData()">æ¸…ç†localStorage</button>
            <button onclick="disconnectAll()">æ–­å¼€æ‰€æœ‰è¿æ¥</button>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        let clients = {};

        function log(id, message, type = 'info') {
            const logDiv = document.getElementById(`log${id}`);
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logDiv.innerHTML += `<div style="color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(id, status) {
            const statusDiv = document.getElementById(`status${id}`);
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = status === 'connected' ? 'å·²è¿æ¥' :
                                   status === 'connecting' ? 'è¿æ¥ä¸­...' : 'æœªè¿æ¥';
        }

        function testBasicConnection() {
            log(1, 'å¼€å§‹æµ‹è¯•åŸºç¡€MQTTè¿æ¥...');
            updateStatus(1, 'connecting');

            const client = mqtt.connect('wss://test.mosquitto.org:8081/mqtt', {
                clientId: `test_${Math.random().toString(16).substr(2, 8)}`,
                clean: true,
                connectTimeout: 10000
            });

            client.on('connect', () => {
                log(1, 'âœ… æˆåŠŸè¿æ¥åˆ°MQTTæœåŠ¡å™¨ï¼', 'success');
                updateStatus(1, 'connected');

                // æµ‹è¯•è®¢é˜…
                client.subscribe('test/topic', (err) => {
                    if (err) {
                        log(1, `âŒ è®¢é˜…å¤±è´¥: ${err.message}`, 'error');
                    } else {
                        log(1, 'âœ… æˆåŠŸè®¢é˜…æµ‹è¯•ä¸»é¢˜', 'success');
                    }
                });

                // æµ‹è¯•å‘å¸ƒ
                setTimeout(() => {
                    client.publish('test/topic', 'Hello MQTT!', (err) => {
                        if (err) {
                            log(1, `âŒ å‘å¸ƒå¤±è´¥: ${err.message}`, 'error');
                        } else {
                            log(1, 'âœ… æˆåŠŸå‘å¸ƒæµ‹è¯•æ¶ˆæ¯', 'success');
                        }
                    });
                }, 1000);
            });

            client.on('error', (err) => {
                log(1, `âŒ è¿æ¥é”™è¯¯: ${err.message}`, 'error');
                updateStatus(1, 'disconnected');
            });

            client.on('message', (topic, message) => {
                log(1, `ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${message.toString()}`);
            });

            clients['test1'] = client;
        }

        function createNormalRoom() {
            const roomId = document.getElementById('room2').value;
            const nickname = document.getElementById('nick2').value;

            log(2, `åˆ›å»ºæˆ¿é—´: ${roomId}, æ˜µç§°: ${nickname}`);
            updateStatus(2, 'connecting');

            const client = mqtt.connect('wss://test.mosquitto.org:8081/mqtt', {
                clientId: `room_${Math.random().toString(16).substr(2, 8)}`,
                clean: true,
                will: {
                    topic: `game/${roomId}/presence`,
                    payload: JSON.stringify({
                        type: 'leave',
                        name: nickname,
                        timestamp: Date.now()
                    })
                }
            });

            client.on('connect', () => {
                log(2, 'âœ… è¿æ¥æˆåŠŸï¼', 'success');
                updateStatus(2, 'connected');

                const topics = [
                    `game/${roomId}/messages`,
                    `game/${roomId}/presence`,
                    `game/${roomId}/config`
                ];

                client.subscribe(topics, (err) => {
                    if (err) {
                        log(2, `âŒ è®¢é˜…å¤±è´¥: ${err.message}`, 'error');
                    } else {
                        log(2, 'âœ… æˆåŠŸè®¢é˜…æˆ¿é—´ä¸»é¢˜', 'success');

                        // å‘é€åŠ å…¥æ¶ˆæ¯
                        client.publish(`game/${roomId}/presence`, JSON.stringify({
                            type: 'join',
                            name: nickname,
                            timestamp: Date.now()
                        }));
                        log(2, 'ğŸ“¤ å‘é€åŠ å…¥æ¶ˆæ¯');
                    }
                });
            });

            client.on('error', (err) => {
                log(2, `âŒ é”™è¯¯: ${err.message}`, 'error');
                updateStatus(2, 'disconnected');
            });

            client.on('message', (topic, message) => {
                try {
                    const data = JSON.parse(message.toString());
                    if (topic.includes('presence')) {
                        log(2, `ğŸ‘¤ ${data.name} ${data.type === 'join' ? 'åŠ å…¥' : 'ç¦»å¼€'}æˆ¿é—´`);
                    } else if (topic.includes('config')) {
                        log(2, `ğŸ“‹ æ”¶åˆ°æˆ¿é—´é…ç½®`);
                    }
                } catch (e) {
                    log(2, `ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${message.toString()}`);
                }
            });

            clients['room2'] = client;
        }

        function joinNormalRoom() {
            const roomId = document.getElementById('room3').value;
            const nickname = document.getElementById('nick3').value;

            log(3, `åŠ å…¥æˆ¿é—´: ${roomId}, æ˜µç§°: ${nickname}`);
            updateStatus(3, 'connecting');

            const client = mqtt.connect('wss://test.mosquitto.org:8081/mqtt', {
                clientId: `join_${Math.random().toString(16).substr(2, 8)}`,
                clean: true,
                will: {
                    topic: `game/${roomId}/presence`,
                    payload: JSON.stringify({
                        type: 'leave',
                        name: nickname,
                        timestamp: Date.now()
                    })
                }
            });

            client.on('connect', () => {
                log(3, 'âœ… è¿æ¥æˆåŠŸï¼', 'success');
                updateStatus(3, 'connected');

                const topics = [
                    `game/${roomId}/messages`,
                    `game/${roomId}/presence`,
                    `game/${roomId}/config`
                ];

                client.subscribe(topics, (err) => {
                    if (err) {
                        log(3, `âŒ è®¢é˜…å¤±è´¥: ${err.message}`, 'error');
                    } else {
                        log(3, 'âœ… æˆåŠŸè®¢é˜…æˆ¿é—´ä¸»é¢˜', 'success');

                        // å‘é€åŠ å…¥æ¶ˆæ¯
                        client.publish(`game/${roomId}/presence`, JSON.stringify({
                            type: 'join',
                            name: nickname,
                            timestamp: Date.now()
                        }));
                        log(3, 'ğŸ“¤ å‘é€åŠ å…¥æ¶ˆæ¯');
                    }
                });
            });

            client.on('error', (err) => {
                log(3, `âŒ é”™è¯¯: ${err.message}`, 'error');
                updateStatus(3, 'disconnected');
            });

            client.on('message', (topic, message) => {
                try {
                    const data = JSON.parse(message.toString());
                    if (topic.includes('presence')) {
                        log(3, `ğŸ‘¤ ${data.name} ${data.type === 'join' ? 'åŠ å…¥' : 'ç¦»å¼€'}æˆ¿é—´`);
                    } else if (topic.includes('config')) {
                        log(3, `ğŸ“‹ æ”¶åˆ°æˆ¿é—´é…ç½®: ${data.hasPassword ? 'éœ€è¦å¯†ç ' : 'æ— éœ€å¯†ç '}`);
                    }
                } catch (e) {
                    log(3, `ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯: ${message.toString()}`);
                }
            });

            clients['room3'] = client;
        }

        function clearTestData() {
            localStorage.removeItem('mqtt_room_configs');
            localStorage.removeItem('mqtt_room_history');
            alert('å·²æ¸…ç†æµ‹è¯•æ•°æ®');
        }

        function disconnectAll() {
            Object.values(clients).forEach(client => {
                if (client.connected) {
                    client.end();
                }
            });
            clients = {};
            alert('å·²æ–­å¼€æ‰€æœ‰è¿æ¥');
        }
    </script>
</body>
</html>