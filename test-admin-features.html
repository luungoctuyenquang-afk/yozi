<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
        }
        
        .test-container {
            width: 375px;
            height: 667px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }
        
        .test-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 140, 0, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 9999;
            pointer-events: none;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }
        
        .admin-test-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            margin: 10px;
        }
        
        .admin-test-panel h3 {
            margin-top: 0;
            color: #ff8c00;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            text-align: center;
        }
        
        .test-section {
            margin: 20px 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: bold;
            color: #495057;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-content {
            padding: 15px;
            display: none;
        }
        
        .section-content.show {
            display: block;
        }
        
        .test-step {
            margin: 10px 0;
            padding: 10px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .test-step.success {
            background: #d1e7dd;
            border-left-color: #198754;
            color: #0f5132;
        }
        
        .test-step.error {
            background: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        
        .test-btn {
            background: #ff8c00;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px 5px 5px 0;
        }
        
        .test-btn:hover {
            background: #e6a800;
        }
        
        .test-btn.success {
            background: #198754;
        }
        
        .test-btn.success:hover {
            background: #157347;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
        }
        
        .toggle-icon.rotated {
            transform: rotate(90deg);
        }
        
        .instruction {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 13px;
        }
        
        .code-snippet {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <!-- MQTTèŠå¤©å®¤æµ‹è¯•å®¹å™¨ -->
    <div class="test-container">
        <div class="test-info">ğŸ‘‘ ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•</div>
        <div id="mqtt-test-container" style="width: 100%; height: 100%;"></div>
    </div>
    
    <!-- ç®¡ç†å‘˜åŠŸèƒ½æµ‹è¯•é¢æ¿ -->
    <div class="admin-test-panel">
        <h3>ğŸ‘‘ ç®¡ç†å‘˜åŠŸèƒ½éªŒè¯</h3>
        
        <!-- å¯†ç ä¿å­˜åŠŸèƒ½æµ‹è¯• -->
        <div class="test-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ” å¯†ç ä¿å­˜åŠŸèƒ½</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="section-content">
                <div class="instruction">
                    <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
                    1. ç‚¹å‡»"âš™ï¸ æˆ¿é—´è®¾ç½®"æŒ‰é’®<br>
                    2. å‹¾é€‰"å¯†ç ä¿æŠ¤æˆ¿é—´"å¤é€‰æ¡†<br>
                    3. è¾“å…¥å¯†ç å¹¶ç‚¹å‡»"ä¿å­˜"æŒ‰é’®<br>
                    4. æ£€æŸ¥æ˜¯å¦æ˜¾ç¤º"å¯†ç å·²ä¿å­˜"æç¤º
                </div>
                
                <div class="test-step" id="password-ui-check">
                    <strong>UIæ£€æŸ¥ï¼š</strong>ç­‰å¾…æ£€æŸ¥å¯†ç ä¿å­˜æŒ‰é’®...
                </div>
                
                <button class="test-btn" onclick="checkPasswordUI()">æ£€æŸ¥å¯†ç UI</button>
                <button class="test-btn" onclick="testPasswordSave()">æ¨¡æ‹Ÿå¯†ç ä¿å­˜</button>
            </div>
        </div>
        
        <!-- è¸¢äººåŠŸèƒ½æµ‹è¯• -->
        <div class="test-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸš« è¸¢äººåŠŸèƒ½UI</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="section-content">
                <div class="instruction">
                    <strong>æµ‹è¯•æ­¥éª¤ï¼š</strong><br>
                    1. åˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´ï¼ˆæˆä¸ºç®¡ç†å‘˜ï¼‰<br>
                    2. ç‚¹å‡»åœ¨çº¿äººæ•°æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨<br>
                    3. æ£€æŸ¥å…¶ä»–ç”¨æˆ·æ˜¯å¦æœ‰è¸¢äººæŒ‰é’®ï¼ˆğŸš«ï¼‰<br>
                    4. æµ‹è¯•ç®¡ç†å‘˜æƒé™è®¾ç½®
                </div>
                
                <div class="test-step" id="admin-ui-check">
                    <strong>ç®¡ç†å‘˜UIæ£€æŸ¥ï¼š</strong>ç­‰å¾…æ£€æŸ¥è¸¢äººæŒ‰é’®...
                </div>
                
                <div class="test-step" id="admin-status">
                    <strong>ç®¡ç†å‘˜çŠ¶æ€ï¼š</strong>ç­‰å¾…è¿æ¥æˆ¿é—´...
                </div>
                
                <button class="test-btn" onclick="checkAdminUI()">æ£€æŸ¥ç®¡ç†å‘˜UI</button>
                <button class="test-btn" onclick="checkAdminStatus()">æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€</button>
                <button class="test-btn success" onclick="createTestRoom()">åˆ›å»ºæµ‹è¯•æˆ¿é—´</button>
            </div>
        </div>
        
        <!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æµ‹è¯• -->
        <div class="test-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ‘¥ åœ¨çº¿ç”¨æˆ·ç®¡ç†</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="section-content">
                <div class="instruction">
                    <strong>ç®¡ç†å‘˜æ“ä½œæŒ‰é’®ï¼š</strong><br>
                    â€¢ ğŸ‘‘ è®¾ä¸ºç®¡ç†å‘˜<br>
                    â€¢ ğŸš« è¸¢å‡ºç”¨æˆ·<br>
                    â€¢ ğŸ‘¤ ç§»é™¤ç®¡ç†å‘˜æƒé™<br>
                    â€¢ ğŸ’¬ ç§èŠ
                </div>
                
                <div class="test-step" id="user-list-check">
                    <strong>ç”¨æˆ·åˆ—è¡¨æ£€æŸ¥ï¼š</strong>ç­‰å¾…è¿æ¥æˆ¿é—´...
                </div>
                
                <button class="test-btn" onclick="checkUserList()">æ£€æŸ¥ç”¨æˆ·åˆ—è¡¨</button>
                <button class="test-btn" onclick="simulateUsers()">æ¨¡æ‹Ÿå¤šç”¨æˆ·</button>
            </div>
        </div>
        
        <!-- è°ƒè¯•ä¿¡æ¯ -->
        <div class="test-section">
            <div class="section-header" onclick="toggleSection(this)">
                <span>ğŸ› è°ƒè¯•ä¿¡æ¯</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="section-content">
                <div class="code-snippet" id="debug-info">
                    ç­‰å¾…åˆå§‹åŒ–...
                </div>
                <button class="test-btn" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
                <button class="test-btn" onclick="clearDebugInfo()">æ¸…é™¤ä¿¡æ¯</button>
            </div>
        </div>
    </div>

    <script>
        let mqttApp = null;
        
        // åˆ‡æ¢åŠŸèƒ½åŒºå—
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('show');
                icon.classList.add('rotated');
            }
        }
        
        // æ›´æ–°æµ‹è¯•æ­¥éª¤çŠ¶æ€
        function updateTestStep(elementId, message, status = 'normal') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<strong>${elementId.replace('-', ' ').toUpperCase()}ï¼š</strong>${message}`;
            
            element.classList.remove('success', 'error');
            if (status === 'success') {
                element.classList.add('success');
            } else if (status === 'error') {
                element.classList.add('error');
            }
        }
        
        // åŠ è½½MQTTèŠå¤©å®¤æ¨¡å—
        async function loadMqttRoomScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'js/screens/mqtt-room.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // åˆå§‹åŒ–MQTTèŠå¤©å®¤
        async function initializeMqttRoom() {
            try {
                await loadMqttRoomScript();
                
                mqttApp = createMqttRoomApp({
                    mountEl: document.getElementById('mqtt-test-container'),
                    getPlayerName: () => 'ç®¡ç†å‘˜æµ‹è¯•ç”¨æˆ·',
                    brokerUrl: 'wss://test.mosquitto.org:8081/mqtt'
                });

                updateDebugInfo('MQTTèŠå¤©å®¤åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                updateDebugInfo('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }
        
        // æ£€æŸ¥å¯†ç UI
        function checkPasswordUI() {
            const container = document.getElementById('mqtt-test-container');
            
            // æ£€æŸ¥å¯†ç ç›¸å…³å…ƒç´ 
            const passwordCheckbox = container.querySelector('#private-room-checkbox');
            const passwordInput = container.querySelector('.room-password-input');
            const savePasswordBtn = container.querySelector('#save-password-btn');
            const passwordInputGroup = container.querySelector('.password-input-group');
            
            let result = [];
            
            if (passwordCheckbox) {
                result.push('âœ… å¯†ç å¤é€‰æ¡†å­˜åœ¨');
            } else {
                result.push('âŒ å¯†ç å¤é€‰æ¡†ç¼ºå¤±');
            }
            
            if (passwordInput) {
                result.push('âœ… å¯†ç è¾“å…¥æ¡†å­˜åœ¨');
            } else {
                result.push('âŒ å¯†ç è¾“å…¥æ¡†ç¼ºå¤±');
            }
            
            if (savePasswordBtn) {
                result.push('âœ… ä¿å­˜å¯†ç æŒ‰é’®å­˜åœ¨');
            } else {
                result.push('âŒ ä¿å­˜å¯†ç æŒ‰é’®ç¼ºå¤±');
            }
            
            if (passwordInputGroup) {
                result.push('âœ… å¯†ç è¾“å…¥ç»„å­˜åœ¨');
            } else {
                result.push('âŒ å¯†ç è¾“å…¥ç»„ç¼ºå¤±');
            }
            
            const status = result.every(r => r.startsWith('âœ…')) ? 'success' : 'error';
            updateTestStep('password-ui-check', result.join('<br>'), status);
        }
        
        // æ¨¡æ‹Ÿå¯†ç ä¿å­˜
        function testPasswordSave() {
            const container = document.getElementById('mqtt-test-container');
            const passwordCheckbox = container.querySelector('#private-room-checkbox');
            const passwordInput = container.querySelector('.room-password-input');
            const savePasswordBtn = container.querySelector('#save-password-btn');
            
            if (passwordCheckbox && passwordInput && savePasswordBtn) {
                // æ¨¡æ‹Ÿå‹¾é€‰å¯†ç ä¿æŠ¤
                passwordCheckbox.checked = true;
                passwordCheckbox.dispatchEvent(new Event('change'));
                
                // è¾“å…¥æµ‹è¯•å¯†ç 
                passwordInput.value = 'test123';
                
                // ç‚¹å‡»ä¿å­˜æŒ‰é’®
                setTimeout(() => {
                    savePasswordBtn.click();
                    updateTestStep('password-ui-check', 'âœ… å¯†ç ä¿å­˜æµ‹è¯•å®Œæˆï¼Œè¯·æŸ¥çœ‹æ˜¯å¦æœ‰"å¯†ç å·²ä¿å­˜"æç¤º', 'success');
                }, 500);
            } else {
                updateTestStep('password-ui-check', 'âŒ æ— æ³•æ‰¾åˆ°å¯†ç ç›¸å…³å…ƒç´ ', 'error');
            }
        }
        
        // æ£€æŸ¥ç®¡ç†å‘˜UI
        function checkAdminUI() {
            const container = document.getElementById('mqtt-test-container');
            
            // æ£€æŸ¥åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ç›¸å…³å…ƒç´ 
            const onlineList = container.querySelector('#online-list');
            const onlineCount = container.querySelector('#online-count');
            const onlineListContent = container.querySelector('#online-list-content');
            
            let result = [];
            
            if (onlineList) {
                result.push('âœ… åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å®¹å™¨å­˜åœ¨');
            } else {
                result.push('âŒ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å®¹å™¨ç¼ºå¤±');
            }
            
            if (onlineCount) {
                result.push('âœ… åœ¨çº¿äººæ•°æ˜¾ç¤ºå­˜åœ¨');
            } else {
                result.push('âŒ åœ¨çº¿äººæ•°æ˜¾ç¤ºç¼ºå¤±');
            }
            
            if (onlineListContent) {
                result.push('âœ… ç”¨æˆ·åˆ—è¡¨å†…å®¹åŒºåŸŸå­˜åœ¨');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜æŒ‰é’®
                const adminBtns = onlineListContent.querySelectorAll('.kick-btn, .admin-action-btn');
                if (adminBtns.length > 0) {
                    result.push(`âœ… æ‰¾åˆ° ${adminBtns.length} ä¸ªç®¡ç†å‘˜æ“ä½œæŒ‰é’®`);
                } else {
                    result.push('âš ï¸ æš‚æ— ç®¡ç†å‘˜æ“ä½œæŒ‰é’®ï¼ˆå¯èƒ½éœ€è¦å…ˆè¿æ¥æˆ¿é—´ï¼‰');
                }
            } else {
                result.push('âŒ ç”¨æˆ·åˆ—è¡¨å†…å®¹åŒºåŸŸç¼ºå¤±');
            }
            
            const status = result.filter(r => r.startsWith('âŒ')).length > 0 ? 'error' : 'success';
            updateTestStep('admin-ui-check', result.join('<br>'), status);
        }
        
        // æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€
        function checkAdminStatus() {
            updateDebugInfo('æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€...');
            
            // å°è¯•è®¿é—®å…¨å±€å˜é‡ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            try {
                const container = document.getElementById('mqtt-test-container');
                const settingsBtn = container.querySelector('#settings-toggle-btn');
                
                if (settingsBtn) {
                    updateTestStep('admin-status', 'âœ… æˆ¿é—´è®¾ç½®æŒ‰é’®å¯ç”¨ï¼Œå¯èƒ½æœ‰ç®¡ç†å‘˜æƒé™', 'success');
                } else {
                    updateTestStep('admin-status', 'âš ï¸ æˆ¿é—´è®¾ç½®æŒ‰é’®ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                updateTestStep('admin-status', 'âŒ æ— æ³•æ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€: ' + error.message, 'error');
            }
        }
        
        // åˆ›å»ºæµ‹è¯•æˆ¿é—´
        function createTestRoom() {
            const container = document.getElementById('mqtt-test-container');
            const roomInput = container.querySelector('.room-input');
            const nicknameInput = container.querySelector('.nickname-input');
            const createBtn = container.querySelector('#btn-create-room');
            
            if (roomInput && nicknameInput && createBtn) {
                // è‡ªåŠ¨å¡«å……æµ‹è¯•æ•°æ®
                roomInput.value = 'admin-test-' + Math.random().toString(36).substr(2, 6);
                nicknameInput.value = 'ç®¡ç†å‘˜';
                
                // ç‚¹å‡»åˆ›å»ºæˆ¿é—´
                createBtn.click();
                
                updateTestStep('admin-status', 'âœ… å·²å°è¯•åˆ›å»ºæµ‹è¯•æˆ¿é—´ï¼Œè¯·ç­‰å¾…è¿æ¥...', 'success');
                
                // 3ç§’åæ£€æŸ¥çŠ¶æ€
                setTimeout(() => {
                    checkAdminStatus();
                    checkUserList();
                }, 3000);
            } else {
                updateTestStep('admin-status', 'âŒ æ— æ³•æ‰¾åˆ°æˆ¿é—´åˆ›å»ºç›¸å…³å…ƒç´ ', 'error');
            }
        }
        
        // æ£€æŸ¥ç”¨æˆ·åˆ—è¡¨
        function checkUserList() {
            const container = document.getElementById('mqtt-test-container');
            const onlineListContent = container.querySelector('#online-list-content');
            
            if (onlineListContent) {
                const users = onlineListContent.querySelectorAll('.online-user');
                const kickBtns = onlineListContent.querySelectorAll('.kick-btn');
                const adminBtns = onlineListContent.querySelectorAll('.admin-action-btn');
                
                let result = `ç”¨æˆ·æ•°é‡: ${users.length}<br>`;
                result += `è¸¢äººæŒ‰é’®: ${kickBtns.length}<br>`;
                result += `ç®¡ç†å‘˜æŒ‰é’®: ${adminBtns.length}`;
                
                const status = users.length > 0 ? 'success' : 'error';
                updateTestStep('user-list-check', result, status);
            } else {
                updateTestStep('user-list-check', 'âŒ æ— æ³•æ‰¾åˆ°ç”¨æˆ·åˆ—è¡¨å†…å®¹', 'error');
            }
        }
        
        // æ¨¡æ‹Ÿå¤šç”¨æˆ·
        function simulateUsers() {
            updateTestStep('user-list-check', 'âš ï¸ æ¨¡æ‹Ÿå¤šç”¨æˆ·åŠŸèƒ½éœ€è¦å®é™…çš„MQTTè¿æ¥å’Œå¤šä¸ªå®¢æˆ·ç«¯', 'normal');
            updateDebugInfo('æç¤ºï¼šè¦æµ‹è¯•è¸¢äººåŠŸèƒ½ï¼Œéœ€è¦åœ¨å¦ä¸€ä¸ªæµè§ˆå™¨çª—å£ä¸­åŠ å…¥ç›¸åŒæˆ¿é—´');
        }
        
        // æ›´æ–°è°ƒè¯•ä¿¡æ¯
        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugElement.innerHTML += `[${timestamp}] ${message}<br>`;
            debugElement.scrollTop = debugElement.scrollHeight;
        }
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
        function showDebugInfo() {
            const container = document.getElementById('mqtt-test-container');
            let info = '=== DOMå…ƒç´ æ£€æŸ¥ ===<br>';
            
            const elements = [
                { name: 'å¯†ç å¤é€‰æ¡†', selector: '#private-room-checkbox' },
                { name: 'å¯†ç è¾“å…¥æ¡†', selector: '.room-password-input' },
                { name: 'ä¿å­˜å¯†ç æŒ‰é’®', selector: '#save-password-btn' },
                { name: 'åœ¨çº¿ç”¨æˆ·åˆ—è¡¨', selector: '#online-list' },
                { name: 'ç”¨æˆ·åˆ—è¡¨å†…å®¹', selector: '#online-list-content' },
                { name: 'æˆ¿é—´è®¾ç½®æŒ‰é’®', selector: '#settings-toggle-btn' }
            ];
            
            elements.forEach(el => {
                const found = container.querySelector(el.selector);
                info += `${el.name}: ${found ? 'âœ…' : 'âŒ'}<br>`;
            });
            
            document.getElementById('debug-info').innerHTML = info;
        }
        
        // æ¸…é™¤è°ƒè¯•ä¿¡æ¯
        function clearDebugInfo() {
            document.getElementById('debug-info').innerHTML = 'è°ƒè¯•ä¿¡æ¯å·²æ¸…é™¤...<br>';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeMqttRoom();
            
            // è‡ªåŠ¨å±•å¼€ç¬¬ä¸€ä¸ªåŒºå—
            setTimeout(() => {
                const firstHeader = document.querySelector('.section-header');
                if (firstHeader) toggleSection(firstHeader);
            }, 500);
            
            // å®šæœŸæ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€
            setInterval(() => {
                const container = document.getElementById('mqtt-test-container');
                if (container) {
                    const messageInput = container.querySelector('.message-input');
                    if (messageInput && !messageInput.disabled) {
                        // å·²è¿æ¥ï¼Œæ£€æŸ¥ç®¡ç†å‘˜çŠ¶æ€
                        checkAdminStatus();
                    }
                }
            }, 5000);
        });
    </script>
</body>
</html>