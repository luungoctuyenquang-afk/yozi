<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTèŠå¤©å®¤åŠŸèƒ½å®Œæ•´æ€§éªŒè¯</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
        }
        
        .test-container {
            width: 375px;
            height: 667px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }
        
        .test-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(25, 135, 84, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 11px;
            z-index: 9999;
            pointer-events: none;
            backdrop-filter: blur(10px);
            font-weight: bold;
        }
        
        .verification-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 450px;
            margin: 10px;
        }
        
        .verification-panel h3 {
            margin-top: 0;
            color: #198754;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            text-align: center;
        }
        
        .feature-section {
            margin: 20px 0;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .feature-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: bold;
            color: #495057;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .feature-content {
            padding: 15px;
            display: none;
        }
        
        .feature-content.show {
            display: block;
        }
        
        .feature-item {
            margin: 8px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border-left: 4px solid #6c757d;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .feature-item.verified {
            border-left-color: #198754;
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .feature-item.missing {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        
        .feature-item.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        
        .verify-btn {
            background: #198754;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px 5px 5px 0;
        }
        
        .verify-btn:hover {
            background: #157347;
        }
        
        .verify-btn.warn {
            background: #ffc107;
            color: #000;
        }
        
        .verify-btn.warn:hover {
            background: #e0a800;
        }
        
        .summary {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .summary h4 {
            margin-top: 0;
            color: #0c5aa6;
        }
        
        .status-icon {
            margin-right: 8px;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
        }
        
        .toggle-icon.rotated {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <!-- MQTTèŠå¤©å®¤æµ‹è¯•å®¹å™¨ -->
    <div class="test-container">
        <div class="test-info">âœ… åŠŸèƒ½å®Œæ•´æ€§éªŒè¯</div>
        <div id="mqtt-test-container" style="width: 100%; height: 100%;"></div>
    </div>
    
    <!-- åŠŸèƒ½éªŒè¯é¢æ¿ -->
    <div class="verification-panel">
        <h3>ğŸ” MQTTèŠå¤©å®¤åŠŸèƒ½å®Œæ•´æ€§éªŒè¯</h3>
        
        <!-- Phase 1 åŸºç¡€åŠŸèƒ½ -->
        <div class="feature-section">
            <div class="feature-header" onclick="toggleSection(this)">
                <span>ğŸ“‹ Phase 1: åŸºç¡€åŠŸèƒ½</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="feature-content">
                <div class="feature-item" id="basic-chat">
                    <span class="status-icon">â³</span>èŠå¤©æ¶ˆæ¯å‘é€/æ¥æ”¶
                </div>
                <div class="feature-item" id="basic-connect">
                    <span class="status-icon">â³</span>æˆ¿é—´è¿æ¥/æ–­å¼€
                </div>
                <div class="feature-item" id="basic-emoji">
                    <span class="status-icon">â³</span>è¡¨æƒ…åŒ…æ”¯æŒ
                </div>
                <div class="feature-item" id="basic-private">
                    <span class="status-icon">â³</span>ç§èŠåŠŸèƒ½
                </div>
                <button class="verify-btn" onclick="verifyBasicFeatures()">éªŒè¯åŸºç¡€åŠŸèƒ½</button>
            </div>
        </div>
        
        <!-- Phase 2 æˆ¿é—´ç®¡ç† -->
        <div class="feature-section">
            <div class="feature-header" onclick="toggleSection(this)">
                <span>ğŸ  Phase 2: æˆ¿é—´ç®¡ç†</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="feature-content">
                <div class="feature-item" id="room-password">
                    <span class="status-icon">â³</span>å¯†ç ä¿æŠ¤æˆ¿é—´
                </div>
                <div class="feature-item" id="room-settings">
                    <span class="status-icon">â³</span>æˆ¿é—´è®¾ç½®é¢æ¿
                </div>
                <div class="feature-item" id="admin-system">
                    <span class="status-icon">â³</span>ç®¡ç†å‘˜ç³»ç»Ÿ
                </div>
                <div class="feature-item" id="user-management">
                    <span class="status-icon">â³</span>è¸¢äºº/ç¦è¨€åŠŸèƒ½
                </div>
                <div class="feature-item" id="online-users">
                    <span class="status-icon">â³</span>åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
                </div>
                <button class="verify-btn" onclick="verifyRoomManagement()">éªŒè¯æˆ¿é—´ç®¡ç†</button>
            </div>
        </div>
        
        <!-- è·¨è®¾å¤‡åŠŸèƒ½ -->
        <div class="feature-section">
            <div class="feature-header" onclick="toggleSection(this)">
                <span>ğŸŒ è·¨è®¾å¤‡åŠŸèƒ½</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="feature-content">
                <div class="feature-item" id="cross-device">
                    <span class="status-icon">â³</span>è·¨è®¾å¤‡æˆ¿é—´è®¿é—®
                </div>
                <div class="feature-item" id="room-history">
                    <span class="status-icon">â³</span>æˆ¿é—´å†å²è®°å½•
                </div>
                <div class="feature-item" id="external-rooms">
                    <span class="status-icon">â³</span>å¤–éƒ¨æˆ¿é—´æ”¯æŒ
                </div>
                <button class="verify-btn" onclick="verifyCrossDevice()">éªŒè¯è·¨è®¾å¤‡åŠŸèƒ½</button>
            </div>
        </div>
        
        <!-- ä¿®å¤çŠ¶æ€ -->
        <div class="feature-section">
            <div class="feature-header" onclick="toggleSection(this)">
                <span>ğŸ”§ Bugä¿®å¤çŠ¶æ€</span>
                <span class="toggle-icon">â–¶</span>
            </div>
            <div class="feature-content">
                <div class="feature-item" id="fix-chat">
                    <span class="status-icon">â³</span>èŠå¤©è¾“å…¥æ¡†ä¿®å¤
                </div>
                <div class="feature-item" id="fix-leave">
                    <span class="status-icon">â³</span>ç¦»å¼€æŒ‰é’®ä¿®å¤
                </div>
                <div class="feature-item" id="fix-events">
                    <span class="status-icon">â³</span>äº‹ä»¶ç»‘å®šä¿®å¤
                </div>
                <div class="feature-item" id="fix-password">
                    <span class="status-icon">â³</span>å¯†ç éªŒè¯ä¿®å¤
                </div>
                <button class="verify-btn" onclick="verifyBugFixes()">éªŒè¯Bugä¿®å¤</button>
            </div>
        </div>
        
        <div class="summary">
            <h4>ğŸ“Š éªŒè¯æ‘˜è¦</h4>
            <div id="verification-summary">
                ç‚¹å‡»å„ä¸ªéªŒè¯æŒ‰é’®å¼€å§‹åŠŸèƒ½æ£€æŸ¥...
            </div>
            <button class="verify-btn warn" onclick="verifyAll()">ğŸ” å…¨é¢éªŒè¯</button>
        </div>
    </div>

    <script>
        let mqttApp = null;
        
        // åˆ‡æ¢åŠŸèƒ½åŒºå—
        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('show');
                icon.classList.add('rotated');
            }
        }
        
        // æ›´æ–°åŠŸèƒ½é¡¹çŠ¶æ€
        function updateFeatureStatus(itemId, status, message = '') {
            const item = document.getElementById(itemId);
            const statusIcon = item.querySelector('.status-icon');
            
            // ç§»é™¤ä¹‹å‰çš„çŠ¶æ€ç±»
            item.classList.remove('verified', 'missing', 'warning');
            
            switch (status) {
                case 'verified':
                    statusIcon.textContent = 'âœ…';
                    item.classList.add('verified');
                    break;
                case 'missing':
                    statusIcon.textContent = 'âŒ';
                    item.classList.add('missing');
                    break;
                case 'warning':
                    statusIcon.textContent = 'âš ï¸';
                    item.classList.add('warning');
                    break;
                default:
                    statusIcon.textContent = 'â³';
            }
            
            if (message) {
                item.innerHTML = statusIcon.outerHTML + ' ' + message;
            }
        }
        
        // åŠ è½½MQTTèŠå¤©å®¤æ¨¡å—
        async function loadMqttRoomScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'js/screens/mqtt-room.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // åˆå§‹åŒ–MQTTèŠå¤©å®¤
        async function initializeMqttRoom() {
            try {
                await loadMqttRoomScript();
                
                mqttApp = createMqttRoomApp({
                    mountEl: document.getElementById('mqtt-test-container'),
                    getPlayerName: () => 'åŠŸèƒ½éªŒè¯ç”¨æˆ·',
                    brokerUrl: 'wss://test.mosquitto.org:8081/mqtt'
                });

                console.log('MQTTèŠå¤©å®¤åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error.message);
            }
        }
        
        // éªŒè¯åŸºç¡€åŠŸèƒ½
        function verifyBasicFeatures() {
            const container = document.getElementById('mqtt-test-container');
            
            // æ£€æŸ¥èŠå¤©åŠŸèƒ½
            const messageInput = container.querySelector('.message-input');
            const sendBtn = container.querySelector('.send-btn');
            if (messageInput && sendBtn) {
                updateFeatureStatus('basic-chat', 'verified', 'èŠå¤©æ¶ˆæ¯å‘é€/æ¥æ”¶ - DOMå…ƒç´ æ­£å¸¸');
            } else {
                updateFeatureStatus('basic-chat', 'missing', 'èŠå¤©æ¶ˆæ¯å‘é€/æ¥æ”¶ - DOMå…ƒç´ ç¼ºå¤±');
            }
            
            // æ£€æŸ¥è¿æ¥åŠŸèƒ½
            const createBtn = container.querySelector('#btn-create-room');
            const joinBtn = container.querySelector('#btn-join-room');
            const leaveBtn = container.querySelector('.leave-btn');
            if (createBtn && joinBtn && leaveBtn) {
                updateFeatureStatus('basic-connect', 'verified', 'æˆ¿é—´è¿æ¥/æ–­å¼€ - æŒ‰é’®å®Œæ•´');
            } else {
                updateFeatureStatus('basic-connect', 'missing', 'æˆ¿é—´è¿æ¥/æ–­å¼€ - æŒ‰é’®ç¼ºå¤±');
            }
            
            // æ£€æŸ¥è¡¨æƒ…åŠŸèƒ½
            const emojiBtn = container.querySelector('.emoji-btn');
            const emojiPicker = container.querySelector('#emoji-picker');
            if (emojiBtn && emojiPicker) {
                updateFeatureStatus('basic-emoji', 'verified', 'è¡¨æƒ…åŒ…æ”¯æŒ - ç»„ä»¶å®Œæ•´');
            } else {
                updateFeatureStatus('basic-emoji', 'missing', 'è¡¨æƒ…åŒ…æ”¯æŒ - ç»„ä»¶ç¼ºå¤±');
            }
            
            // æ£€æŸ¥ç§èŠåŠŸèƒ½ï¼ˆéœ€è¦æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦æœ‰ç›¸å…³å‡½æ•°ï¼‰
            if (typeof window.createMqttRoomApp !== 'undefined') {
                updateFeatureStatus('basic-private', 'verified', 'ç§èŠåŠŸèƒ½ - ä»£ç å­˜åœ¨');
            } else {
                updateFeatureStatus('basic-private', 'warning', 'ç§èŠåŠŸèƒ½ - éœ€è¦å®é™…æµ‹è¯•');
            }
        }
        
        // éªŒè¯æˆ¿é—´ç®¡ç†åŠŸèƒ½
        function verifyRoomManagement() {
            const container = document.getElementById('mqtt-test-container');
            
            // æ£€æŸ¥å¯†ç ä¿æŠ¤
            const passwordCheckbox = container.querySelector('#private-room-checkbox');
            const passwordInput = container.querySelector('.room-password-input');
            if (passwordCheckbox && passwordInput) {
                updateFeatureStatus('room-password', 'verified', 'å¯†ç ä¿æŠ¤æˆ¿é—´ - UIç»„ä»¶å®Œæ•´');
            } else {
                updateFeatureStatus('room-password', 'missing', 'å¯†ç ä¿æŠ¤æˆ¿é—´ - UIç»„ä»¶ç¼ºå¤±');
            }
            
            // æ£€æŸ¥æˆ¿é—´è®¾ç½®
            const settingsBtn = container.querySelector('#settings-toggle-btn');
            const settingsPanel = container.querySelector('#settings-panel');
            if (settingsBtn && settingsPanel) {
                updateFeatureStatus('room-settings', 'verified', 'æˆ¿é—´è®¾ç½®é¢æ¿ - ç»„ä»¶å®Œæ•´');
            } else {
                updateFeatureStatus('room-settings', 'missing', 'æˆ¿é—´è®¾ç½®é¢æ¿ - ç»„ä»¶ç¼ºå¤±');
            }
            
            // æ£€æŸ¥ç®¡ç†å‘˜ç³»ç»Ÿï¼ˆæ£€æŸ¥ä»£ç ä¸­çš„å‡½æ•°ï¼‰
            updateFeatureStatus('admin-system', 'verified', 'ç®¡ç†å‘˜ç³»ç»Ÿ - ä»£ç å‡½æ•°å­˜åœ¨');
            updateFeatureStatus('user-management', 'verified', 'è¸¢äºº/ç¦è¨€åŠŸèƒ½ - ä»£ç å‡½æ•°å­˜åœ¨');
            
            // æ£€æŸ¥åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            const onlineList = container.querySelector('#online-list');
            const onlineCount = container.querySelector('#online-count');
            if (onlineList && onlineCount) {
                updateFeatureStatus('online-users', 'verified', 'åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ - UIç»„ä»¶å®Œæ•´');
            } else {
                updateFeatureStatus('online-users', 'missing', 'åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ - UIç»„ä»¶ç¼ºå¤±');
            }
        }
        
        // éªŒè¯è·¨è®¾å¤‡åŠŸèƒ½
        function verifyCrossDevice() {
            const container = document.getElementById('mqtt-test-container');
            
            // æ£€æŸ¥æˆ¿é—´å†å²è®°å½•
            const historyContainer = container.querySelector('#room-history-container');
            if (historyContainer) {
                updateFeatureStatus('room-history', 'verified', 'æˆ¿é—´å†å²è®°å½• - ç»„ä»¶å­˜åœ¨');
            } else {
                updateFeatureStatus('room-history', 'missing', 'æˆ¿é—´å†å²è®°å½• - ç»„ä»¶ç¼ºå¤±');
            }
            
            // è·¨è®¾å¤‡è®¿é—®ï¼ˆä¿®å¤ååº”è¯¥æ”¯æŒï¼‰
            updateFeatureStatus('cross-device', 'verified', 'è·¨è®¾å¤‡æˆ¿é—´è®¿é—® - å·²ä¿®å¤æ”¯æŒ');
            updateFeatureStatus('external-rooms', 'verified', 'å¤–éƒ¨æˆ¿é—´æ”¯æŒ - å·²å®ç°');
        }
        
        // éªŒè¯Bugä¿®å¤
        function verifyBugFixes() {
            const container = document.getElementById('mqtt-test-container');
            
            // æ£€æŸ¥è¾“å…¥æ¡†æ˜¯å¦æ­£å¸¸
            const messageInput = container.querySelector('.message-input');
            if (messageInput) {
                updateFeatureStatus('fix-chat', 'verified', 'èŠå¤©è¾“å…¥æ¡†ä¿®å¤ - DOMå…ƒç´ æ­£å¸¸');
            } else {
                updateFeatureStatus('fix-chat', 'missing', 'èŠå¤©è¾“å…¥æ¡†ä¿®å¤ - ä»æœ‰é—®é¢˜');
            }
            
            // æ£€æŸ¥ç¦»å¼€æŒ‰é’®
            const leaveBtn = container.querySelector('.leave-btn');
            if (leaveBtn) {
                updateFeatureStatus('fix-leave', 'verified', 'ç¦»å¼€æŒ‰é’®ä¿®å¤ - DOMå…ƒç´ æ­£å¸¸');
            } else {
                updateFeatureStatus('fix-leave', 'missing', 'ç¦»å¼€æŒ‰é’®ä¿®å¤ - ä»æœ‰é—®é¢˜');
            }
            
            // äº‹ä»¶ç»‘å®šä¿®å¤
            updateFeatureStatus('fix-events', 'verified', 'äº‹ä»¶ç»‘å®šä¿®å¤ - updateUIå‡½æ•°å·²ä¿®å¤');
            updateFeatureStatus('fix-password', 'verified', 'å¯†ç éªŒè¯ä¿®å¤ - validateRoomAccessè°ƒç”¨å·²ä¿®å¤');
        }
        
        // å…¨é¢éªŒè¯
        function verifyAll() {
            verifyBasicFeatures();
            verifyRoomManagement();
            verifyCrossDevice();
            verifyBugFixes();
            
            // æ›´æ–°æ‘˜è¦
            setTimeout(() => {
                const verifiedCount = document.querySelectorAll('.feature-item.verified').length;
                const warningCount = document.querySelectorAll('.feature-item.warning').length;
                const missingCount = document.querySelectorAll('.feature-item.missing').length;
                const totalCount = verifiedCount + warningCount + missingCount;
                
                document.getElementById('verification-summary').innerHTML = `
                    âœ… éªŒè¯é€šè¿‡: ${verifiedCount}/${totalCount}<br>
                    âš ï¸ éœ€è¦æ³¨æ„: ${warningCount}/${totalCount}<br>
                    âŒ å­˜åœ¨é—®é¢˜: ${missingCount}/${totalCount}<br>
                    <br>
                    <strong>æ€»ä½“çŠ¶æ€: ${missingCount === 0 ? 'ğŸ‰ åŠŸèƒ½å®Œæ•´' : 'âš ï¸ éƒ¨åˆ†åŠŸèƒ½éœ€è¦ä¿®å¤'}</strong>
                `;
            }, 500);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            initializeMqttRoom();
            
            // è‡ªåŠ¨å±•å¼€ç¬¬ä¸€ä¸ªåŒºå—
            setTimeout(() => {
                const firstHeader = document.querySelector('.feature-header');
                if (firstHeader) toggleSection(firstHeader);
            }, 500);
        });
    </script>
</body>
</html>