<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTTè¿æ¥æµ‹è¯• - ä¿®å¤éªŒè¯</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .test-button {
            margin: 5px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .test-button:hover {
            background: #5567d8;
        }
        
        .status-box {
            margin: 10px 0;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        
        .link-box {
            margin: 10px 0;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .app-container {
            min-height: 400px;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ MQTTè¿æ¥é—®é¢˜ä¿®å¤æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“ æµ‹è¯•æ­¥éª¤</h2>
            <ol>
                <li>ç‚¹å‡»"ç”Ÿæˆæµ‹è¯•é“¾æ¥"åˆ›å»ºå„ç§ç±»å‹çš„é‚€è¯·é“¾æ¥</li>
                <li>å¤åˆ¶é“¾æ¥åˆ°æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼Œæµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸è¿æ¥</li>
                <li>æˆ–ç‚¹å‡»"æ¨¡æ‹Ÿé“¾æ¥è®¿é—®"ç›´æ¥æµ‹è¯•</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h2>ğŸ”— é“¾æ¥ç”Ÿæˆå™¨</h2>
            <button class="test-button" onclick="generateBasicLink()">ç”ŸæˆåŸºç¡€é“¾æ¥</button>
            <button class="test-button" onclick="generateUidLink()">ç”Ÿæˆå¸¦å¯†é’¥é“¾æ¥</button>
            <button class="test-button" onclick="generateAutoLink()">ç”Ÿæˆè‡ªåŠ¨åŠ å…¥é“¾æ¥</button>
            <div id="link-display" class="link-box" style="display:none;"></div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ§ª è¿æ¥æµ‹è¯•</h2>
            <button class="test-button" onclick="testDirectConnection()">æµ‹è¯•ç›´æ¥è¿æ¥</button>
            <button class="test-button" onclick="simulateLinkVisit()">æ¨¡æ‹Ÿé“¾æ¥è®¿é—®</button>
            <button class="test-button" onclick="clearAndReload()">æ¸…é™¤å¹¶é‡è½½</button>
            <div id="test-status" class="status-box">ç­‰å¾…æµ‹è¯•...</div>
        </div>
        
        <div class="test-section">
            <h2>ğŸ’¬ MQTTèŠå¤©å®¤</h2>
            <div id="mqtt-app" class="app-container"></div>
        </div>
    </div>
    
    <!-- å¼•å…¥MQTTåº“ -->
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    
    <!-- å¼•å…¥ä¿®å¤åçš„MQTTèŠå¤©å®¤æ¨¡å— -->
    <script src="js/screens/mqtt-room.js"></script>
    
    <script>
        let app;
        let testRoomId = 'test_' + Math.random().toString(36).substr(2, 6);
        let testUid = btoa(Math.random().toString()).replace(/=/g, '').substr(0, 32);
        
        // åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('DOMContentLoaded', () => {
            app = createMqttRoomApp({
                mountEl: document.getElementById('mqtt-app'),
                getPlayerName: () => 'æµ‹è¯•ç”¨æˆ·',
                brokerUrl: 'wss://test.mosquitto.org:8081/mqtt'
            });
            
            updateStatus('info', 'âœ… åº”ç”¨å·²åˆå§‹åŒ–ï¼Œå‡†å¤‡æµ‹è¯•');
        });
        
        function updateStatus(type, message) {
            const statusBox = document.getElementById('test-status');
            statusBox.innerHTML += `<div class="${type}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
            statusBox.scrollTop = statusBox.scrollHeight;
        }
        
        // ç”ŸæˆåŸºç¡€é“¾æ¥
        function generateBasicLink() {
            const link = `${window.location.origin}${window.location.pathname}?room=${testRoomId}&nick=è®¿å®¢${Math.floor(Math.random() * 1000)}`;
            showLink(link);
            updateStatus('success', 'âœ… åŸºç¡€é“¾æ¥å·²ç”Ÿæˆ');
        }
        
        // ç”Ÿæˆå¸¦å¯†é’¥çš„é“¾æ¥
        function generateUidLink() {
            const link = `${window.location.origin}${window.location.pathname}?room=${testRoomId}&nick=å¯†é’¥è®¿å®¢&uid=${testUid}`;
            showLink(link);
            updateStatus('success', 'âœ… å¸¦å¯†é’¥é“¾æ¥å·²ç”Ÿæˆ');
        }
        
        // ç”Ÿæˆè‡ªåŠ¨åŠ å…¥é“¾æ¥
        function generateAutoLink() {
            const link = `${window.location.origin}${window.location.pathname}?room=${testRoomId}&nick=è‡ªåŠ¨è®¿å®¢&auto=true`;
            showLink(link);
            updateStatus('success', 'âœ… è‡ªåŠ¨åŠ å…¥é“¾æ¥å·²ç”Ÿæˆ');
        }
        
        function showLink(link) {
            const display = document.getElementById('link-display');
            display.style.display = 'block';
            display.innerHTML = `
                <strong>ç”Ÿæˆçš„é“¾æ¥:</strong><br>
                <a href="${link}" target="_blank">${link}</a><br>
                <button class="test-button" style="margin-top:10px;" onclick="navigator.clipboard.writeText('${link}').then(()=>updateStatus('info', 'ğŸ“‹ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))">å¤åˆ¶é“¾æ¥</button>
            `;
        }
        
        // æµ‹è¯•ç›´æ¥è¿æ¥
        function testDirectConnection() {
            updateStatus('info', 'ğŸ”„ æµ‹è¯•ç›´æ¥è¿æ¥...');
            
            // å¡«å……è¡¨å•
            const roomInput = document.querySelector('#mqtt-app .room-input');
            const nickInput = document.querySelector('#mqtt-app .nickname-input');
            
            if (roomInput && nickInput) {
                roomInput.value = testRoomId;
                nickInput.value = 'ç›´è¿æµ‹è¯•ç”¨æˆ·';
                
                // ç‚¹å‡»åŠ å…¥æŒ‰é’®
                const joinBtn = document.querySelector('#mqtt-app #btn-join-room');
                if (joinBtn) {
                    joinBtn.click();
                    updateStatus('success', 'âœ… å·²å°è¯•ç›´æ¥è¿æ¥');
                } else {
                    updateStatus('error', 'âŒ æ‰¾ä¸åˆ°åŠ å…¥æŒ‰é’®');
                }
            } else {
                updateStatus('error', 'âŒ æ‰¾ä¸åˆ°è¾“å…¥æ¡†');
            }
        }
        
        // æ¨¡æ‹Ÿé“¾æ¥è®¿é—®
        function simulateLinkVisit() {
            updateStatus('info', 'ğŸ”„ æ¨¡æ‹Ÿé€šè¿‡é“¾æ¥è®¿é—®...');
            
            // è®¾ç½®URLå‚æ•°åˆ°windowå¯¹è±¡ï¼ˆæ¨¡æ‹ŸURLå‚æ•°ï¼‰
            const params = new URLSearchParams();
            params.set('room', testRoomId);
            params.set('nick', 'é“¾æ¥è®¿å®¢');
            params.set('uid', testUid);
            
            // ä¿®æ”¹å½“å‰URLï¼ˆä¸åˆ·æ–°é¡µé¢ï¼‰
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);
            
            updateStatus('info', 'ğŸ“ URLå·²æ›´æ–°ï¼Œé‡æ–°åŠ è½½é¡µé¢ä»¥æµ‹è¯•é“¾æ¥...');
            
            // å»¶è¿Ÿåé‡è½½
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        // æ¸…é™¤å¹¶é‡è½½
        function clearAndReload() {
            localStorage.removeItem('mqtt_room_configs');
            window.history.pushState({}, '', window.location.pathname);
            updateStatus('info', 'ğŸ—‘ï¸ å·²æ¸…é™¤æ•°æ®ï¼Œå³å°†é‡è½½...');
            setTimeout(() => location.reload(), 500);
        }
    </script>
</body>
</html>